<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spinner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .game-wrapper {
            background-color: white;
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            width: 95%;
            box-sizing: border-box;
        }
        .game-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
        }
        /* ✅ Adjusted panel widths */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 200px; 
            flex-shrink: 0;
        }
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 340px; /* Increased width */
            flex-shrink: 0;
        }
        #spinner-container {
            position: relative;
            width: 400px;
            height: 400px;
            flex-shrink: 0;
        }
        #spinner-canvas {
            width: 100%;
            height: 100%;
            transition: transform 5s cubic-bezier(0.25, 1, 0.5, 1);
            cursor: pointer;
        }
        #spinner-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid #dc3545;
            z-index: 10;
        }
        .hide { display: none !important; }

        #qa-container, #prompt-container, #mode-select, #scoreboard {
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #prompt-container { font-size: 22px; font-weight: bold; color: #6c757d; min-height:100px; }
        
        #selected-term { font-size: 22px; font-weight: bold; margin-bottom: 10px;}
        #answerInput { padding: 8px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; width: 90%; margin: 10px auto; }
        #feedback { font-weight: bold; min-height: 24px; }
        #choice-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 10px;}
        
        /* ✅ New unified button style */
        .btn {
            background-color: #f0f0f0;
            border: 2px solid #a9a9a9;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #e0e0e0;
        }
        #mode-select .btn { margin: 5px; } /* Spacing for mode buttons */

        .score-display { 
            padding: 15px 20px; border-radius:15px; background-color:#f0f0f0; 
            font-size:18px; text-align:center; transition:all 0.3s ease;
        }
        .score-display:last-child { margin-bottom: 0; }
        .score-display.active { font-weight:bold; background-color:#ffeaa7; transform: scale(1.05); }
        
        .keyboard-controls { padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 10px; }
        #languageSelect { padding: 5px 10px; border-radius: 10px; font-size: 16px; margin-bottom: 10px; border: 1px solid #ccc; width: 100%; }
        #keyboardContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; margin: 0 auto; }
        .keyboard-button { font-size: 20px; width: 40px; height: 40px; padding: 5px; }
    </style>
</head>
<body>

<div class="game-wrapper">
    <h1>Vocabulary Spinner</h1>
    <div class="game-content">
        <div class="left-panel">
            <div id="scoreboard" class="hide">
                <div class="score-display" id="p1-score">Player 1 : <span>0</span></div>
                <div class="score-display hide" id="p2-score">Player 2 : <span>0</span></div>
            </div>
        </div>
        <div id="spinner-container">
            <div id="spinner-pointer"></div>
            <canvas id="spinner-canvas" width="400" height="400"></canvas>
        </div>
        <div class="right-panel">
            <div id="mode-select">
                <p>Select Game Mode:</p>
                <button id="one-player-btn" class="btn">1 Player</button>
                <button id="two-player-btn" class="btn">2 Players</button>
            </div>
            <div id="prompt-container" class="hide">Click the wheel to spin!</div>
            <div id="qa-container" class="hide">
                <div id="selected-term"></div>
                <input type="text" id="answerInput" placeholder="Type term...">
                <button id="submitAnswer" class="btn">Submit</button>
                <div id="feedback">
                    <span id="feedback-text"></span>
                    <div id="choice-buttons" class="hide">
                        <button id="remove-word-btn" class="btn">Remove</button>
                        <button id="keep-word-btn" class="btn">Keep</button>
                    </div>
                </div>
            </div>
            <div class="keyboard-controls hide">
                <select id="languageSelect">
                    <option value="french" selected>French</option>
                    <option value="german">German</option>
                    <option value="spanish">Spanish</option>
                </select>
                <div id="keyboardContainer"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let vocabList = [];
    const colors = ["#1abc9c","#16a085","#2ecc71","#27ae60","#3498db","#2980b9","#9b59b6","#8e44ad","#e74c3c","#c0392b","#d35400","#e67e22","#f1c40f"];
    let currentRotation = 0, lastSelectedItem = null, isSpinning = false, gameOver = false;
    let gameMode = null, currentPlayer = 1, scores = {1:0, 2:0};

    const canvas = document.getElementById('spinner-canvas');
    const ctx = canvas.getContext('2d');
    const qaContainer = document.getElementById('qa-container');
    const promptContainer = document.getElementById('prompt-container');
    const selectedTermEl = document.getElementById('selected-term');
    const answerInputEl = document.getElementById('answerInput');
    const submitAnswerBtn = document.getElementById('submitAnswer');
    const feedbackEl = document.getElementById('feedback');
    const feedbackTextEl = document.getElementById('feedback-text');
    const choiceButtons = document.getElementById('choice-buttons');
    const languageSelect = document.getElementById('languageSelect');
    const keyboardControls = document.querySelector('.keyboard-controls');
    const modeSelect = document.getElementById('mode-select');
    const scoreboard = document.getElementById('scoreboard');
    const p1ScoreEl = document.querySelector('#p1-score span');
    const p1ScoreBox = document.getElementById('p1-score');
    const p2ScoreEl = document.querySelector('#p2-score span');
    const p2ScoreContainer = document.getElementById('p2-score');
    const p2ScoreBox = document.getElementById('p2-score');
    
    const params = new URLSearchParams(window.location.search);
    const sheetUrl = params.get('sheet');
    if (!sheetUrl) { document.querySelector('.game-wrapper').innerHTML = "<h1>⚠️ No sheet URL provided.</h1>"; return; }

    Papa.parse(sheetUrl, {
        download: true, header: false, skipEmptyLines: true,
        complete: (results) => {
            results.data.forEach((row, index) => {
                if (index > 0 && row[1] && row[2]) vocabList.push({term:row[1].trim(), translation:row[2].trim()});
            });
            if (vocabList.length < 2) { document.querySelector('.game-wrapper').innerHTML = "<h1>⚠️ Not enough vocabulary.</h1>"; return; }
            drawSpinner();
            generateKeyboard('french');
        }
    });

    function setUIState(state) {
        modeSelect.classList.toggle('hide', state !== 'mode-select');
        scoreboard.classList.toggle('hide', state === 'mode-select');
        promptContainer.classList.toggle('hide', state !== 'prompt');
        qaContainer.classList.toggle('hide', state !== 'question');
        keyboardControls.classList.toggle('hide', state === 'prompt' || state === 'spinning' || state === 'mode-select');
    }

    function drawSpinner() {
        if (vocabList.length===0) {
            ctx.clearRect(0,0,400,400); ctx.textAlign="center"; ctx.font="20px Arial"; ctx.fillText("All words answered!",200,200);
            gameOver=true; canvas.style.cursor='default'; setUIState('spinning'); return;
        }
        const arc=(2*Math.PI)/vocabList.length; ctx.clearRect(0,0,400,400); ctx.strokeStyle="#333"; ctx.lineWidth=2; ctx.font='14px Arial';
        for(let i=0;i<vocabList.length;i++){ const angle=i*arc; ctx.fillStyle=colors[i%colors.length];
            ctx.beginPath(); ctx.arc(200,200,198,angle,angle+arc,false); ctx.arc(200,200,0,angle+arc,angle,true); ctx.fill(); ctx.stroke();
            ctx.save(); ctx.fillStyle="#fff"; ctx.translate(200,200); ctx.rotate(angle+arc/2); ctx.textAlign="right";
            ctx.fillText(vocabList[i].translation,180,5); ctx.restore();}
    }

    function spin(){
        if(isSpinning||gameOver) return;
        isSpinning=true; setUIState('spinning');
        const selectedIndex=Math.floor(Math.random()*vocabList.length); lastSelectedItem=vocabList[selectedIndex];
        const arcSize=360/vocabList.length; const targetMiddleAngle=(selectedIndex*arcSize)+(arcSize/2);
        let finalOrientation=270-targetMiddleAngle; let finalRotation=finalOrientation;
        while(finalRotation<=currentRotation){finalRotation+=360;} finalRotation+=(Math.floor(Math.random()*4)+4)*360;
        canvas.style.transform=`rotate(${finalRotation}deg)`; currentRotation=finalRotation; setTimeout(onSpinEnd,5000);
    }

    function onSpinEnd(){
        setUIState('question');
        selectedTermEl.classList.remove('hide');
        answerInputEl.classList.remove('hide');
        submitAnswerBtn.classList.remove('hide');
        feedbackEl.classList.add('hide');
        selectedTermEl.textContent=`Translation for: "${lastSelectedItem.translation}"`; 
        answerInputEl.dataset.correctAnswer=lastSelectedItem.term;
        answerInputEl.value=''; 
        answerInputEl.focus();
    }

    function updateScoreDisplay(){ p1ScoreEl.textContent=scores[1]; p2ScoreEl.textContent=scores[2]; }
    function switchTurn(){ 
        currentPlayer = (currentPlayer === 1 ? 2 : 1);
        p1ScoreBox.classList.toggle('active', currentPlayer === 1);
        p2ScoreBox.classList.toggle('active', currentPlayer === 2);
    }

    function handleAnswer(){
        const userAnswer=answerInputEl.value.trim().toLowerCase();
        const correctAnswer=answerInputEl.dataset.correctAnswer.toLowerCase();
        
        if(userAnswer===correctAnswer){
            scores[currentPlayer]++; 
            updateScoreDisplay();
            feedbackTextEl.textContent="✅ Correct!";
            feedbackTextEl.style.color="green";
            selectedTermEl.classList.add('hide');
            answerInputEl.classList.add('hide');
            submitAnswerBtn.classList.add('hide');
            feedbackEl.classList.remove('hide');
            
            if(gameMode === "2p"){
                setTimeout(() => { switchTurn(); continueGame(); }, 1500);
            } else {
                choiceButtons.classList.remove('hide');
            }
        } else {
            if(gameMode === "1p"){
                feedbackEl.classList.remove('hide');
                choiceButtons.classList.add('hide');
                let correctPrefixLength=0;
                for(let i=0;i<userAnswer.length;i++){ if(i<correctAnswer.length&&userAnswer[i]===correctAnswer[i]) correctPrefixLength++; else break; }
                const hint=correctAnswer.substring(0,correctPrefixLength+1);
                feedbackTextEl.textContent=`Hint: ${hint}...`;
                feedbackTextEl.style.color="orange";
                isSpinning = false;
            } else { 
                selectedTermEl.classList.add('hide');
                answerInputEl.classList.add('hide');
                submitAnswerBtn.classList.add('hide');
                feedbackEl.classList.remove('hide');
                feedbackTextEl.textContent="❌ Wrong! Turn passes.";
                feedbackTextEl.style.color="red";
                setTimeout(() => { switchTurn(); continueGame(); }, 1500);
            }
        }
        answerInputEl.value = '';
    }

    function continueGame(){ setUIState('prompt'); isSpinning=false; }

    document.getElementById('remove-word-btn').addEventListener('click',()=>{ if(!lastSelectedItem)return;
        const idx=vocabList.findIndex(item=>item.term===lastSelectedItem.term&&item.translation===lastSelectedItem.translation);
        if(idx>-1) vocabList.splice(idx,1); drawSpinner(); lastSelectedItem=null; continueGame(); });
    document.getElementById('keep-word-btn').addEventListener('click',continueGame);
    
    function generateKeyboard(lang){ const kb=document.getElementById('keyboardContainer'); kb.innerHTML=''; let chars=[];
        if(lang==='french') chars=['à','â','é','è','ê','î','ï','ô','û','ç'];
        else if(lang==='german') chars=['ä','ö','ü','ß'];
        else if(lang==='spanish') chars=['á','é','í','ó','ú','ñ'];
        chars.forEach(c=>{const b=document.createElement('button'); b.className='btn keyboard-button'; b.textContent=c;
        b.onclick=()=>insertLetter(c); kb.appendChild(b);});
    }
    function insertLetter(letter){ const start=answerInputEl.selectionStart; const end=answerInputEl.selectionEnd;
        answerInputEl.value=answerInputEl.value.substring(0,start)+letter+answerInputEl.value.substring(end);
        answerInputEl.selectionStart=answerInputEl.selectionEnd=start+1; answerInputEl.focus(); }

    canvas.addEventListener('click',spin);
    submitAnswerBtn.addEventListener('click',handleAnswer);
    answerInputEl.addEventListener('keypress',(e)=>{if(e.key==='Enter') handleAnswer();});
    languageSelect.addEventListener('change',(e)=>generateKeyboard(e.target.value));

    document.getElementById('one-player-btn').addEventListener('click',()=>{
        gameMode="1p";
        setUIState('prompt');
    });
    document.getElementById('two-player-btn').addEventListener('click',()=>{
        gameMode="2p";
        p2ScoreContainer.classList.remove('hide');
        p1ScoreBox.classList.add('active');
        p2ScoreBox.classList.remove('active');
        setUIState('prompt');
    });
});
</script>
</body>
</html>
