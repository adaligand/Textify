<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rocket Launch</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
/* YOUR ORIGINAL CSS UNCHANGED ‚Äî except the new animation below */

#rocket-img.explode {
    animation: explodeAnim 1.4s ease-out forwards;
}

@keyframes explodeAnim {
    0% { transform: translateX(-50%) scale(1) rotate(0deg); opacity: 1; }
    30% { transform: translateX(-50%) scale(1.4) rotate(25deg); }
    60% { transform: translateX(-50%) scale(1.8) rotate(-45deg); }
    100% { transform: translateX(-50%) scale(0.1) rotate(360deg); opacity: 0; }
}

/* New row under sky frame */
#feedback-row {
    margin-top: 10px;
    display: flex;
    gap: 15px;
    justify-content: center;
    align-items: center;
}
</style>
</head>

<body>

<div id="game-screen" class="screen">
    <div class="title">Rocket Launch</div>
    <div class="subtitle" id="subtitle">Translate the sentence word by word.</div>

    <div class="game-header">
        <div class="counter" id="sentenceCounter"></div>
        <div id="timer-display">1:00</div>
        <div id="lives-container"></div>
    </div>

    <div class="english-sentence" id="english-sentence"></div>

    <div id="sky-container">
        <div id="rocket-wrapper">
            <img id="rocket-img"
                 src="https://adaligand.github.io/Textify/Sentences/rocket.png"
                 alt="rocket">
        </div>
        <div id="cloud-area-wrapper"></div>
    </div>

    <!-- New compact layout under sky -->
    <div id="feedback-row">
        <div id="feedback" class="feedback hide"></div>
        <button id="nextButton" class="btn hide">Next</button>
    </div>
</div>

<div id="end-screen" class="screen hide">
    <h2 class="title" id="end-title"></h2>
    <div class="subtitle" id="end-subtitle"></div>
    <button id="resetButton" class="btn" onclick="resetActivity()">Restart</button>
</div>


<script>
/* ------------------------
   STATE VARIABLES
-------------------------*/
var currentTextIndex = 0;
var originalChunks = [];
var currentChunkIndex = 0;
var sentencePairs = [];
var allFrenchWords = [];
var isGameOver = false;
var lives = 3;

var sentenceTimerId = null;
var remainingTime = 60;

const CRASHANIMATIONDURATION = 1500;
const EXPLOSION_DURATION = 1400;
const LAUNCHANIMATIONDURATION = 2000;

/* DOM */
const rocket = document.getElementById('rocket-img');
const cloudAreaWrapper = document.getElementById('cloud-area-wrapper');
const englishSentenceEl = document.getElementById('english-sentence');
const sentenceCounter = document.getElementById('sentenceCounter');
const livesContainer = document.getElementById('lives-container');
const feedbackElement = document.getElementById('feedback');
const nextButton = document.getElementById('nextButton');
const timerDisplay = document.getElementById('timer-display');
const gameScreen = document.getElementById('game-screen');
const endScreen = document.getElementById('end-screen');
const subtitle = document.getElementById('subtitle');

/* ------------------------
   CSV LOADING
-------------------------*/

const params = new URLSearchParams(window.location.search);
const sheetUrl = params.get('sheet');

if (!sheetUrl) {
    subtitle.textContent = "‚ö†Ô∏è No CSV URL provided. Please add ?sheet=YOUR_LINK to the address bar.";
    gameScreen.style.display = 'flex';
} else {
    subtitle.textContent = "Loading data...";
    gameScreen.style.display = 'flex';

    Papa.parse(sheetUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            let wordSet = new Set();

            results.data.forEach(row => {
                if (row["French sentences"] && row["English sentences"]) {
                    const fr = row["French sentences"].trim();
                    sentencePairs.push({
                        english: row["English sentences"].trim(),
                        french: fr
                    });
                    fr.split(/\s+/).forEach(w => wordSet.add(w));
                }
            });

            allFrenchWords = Array.from(wordSet);

            if (sentencePairs.length === 0) {
                subtitle.textContent = "‚ö†Ô∏è No data found.";
                return;
            }
            if (allFrenchWords.length < 6) {
                subtitle.textContent = "‚ö†Ô∏è Not enough unique words for options.";
                return;
            }

            subtitle.textContent = "Translate the sentence word by word.";
            shuffleArray(sentencePairs);
            startGame();
        }
    });
}

/* ------------------------
   GAME LOGIC
-------------------------*/

function startGame() {
    isGameOver = false;
    currentTextIndex = 0;
    lives = 3;
    stopSentenceTimer();
    shuffleArray(sentencePairs);

    endScreen.classList.add('hide');
    gameScreen.style.display = 'flex';
    displaySentence();
}

function updateLivesDisplay() {
    livesContainer.textContent = '‚ù§Ô∏è'.repeat(lives) + 'üñ§'.repeat(3 - lives);
}

function startSentenceTimer() {
    stopSentenceTimer();
    remainingTime = 60;
    updateTimerDisplay();

    sentenceTimerId = setInterval(() => {
        remainingTime--;
        updateTimerDisplay();
        if (remainingTime <= 0) {
            stopSentenceTimer();
            triggerFailure(null);
        }
    }, 1000);
}

function stopSentenceTimer() {
    if (sentenceTimerId) clearInterval(sentenceTimerId);
    sentenceTimerId = null;
}

function updateTimerDisplay() {
    const m = Math.floor(remainingTime / 60);
    const s = remainingTime % 60;
    timerDisplay.textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
    timerDisplay.style.color = remainingTime <= 10 ? 'red' : '#555';
}

function displaySentence() {
    if (currentTextIndex >= sentencePairs.length) {
        // WIN
        isGameOver = true;
        stopSentenceTimer();
        gameScreen.style.display = 'none';
        endScreen.classList.remove('hide');
        document.getElementById('end-title').textContent = 'üéâ You Win! üéâ';
        document.getElementById('end-subtitle').textContent = "You completed all sentences!";
        return;
    }

    isGameOver = false;
    let pair = sentencePairs[currentTextIndex];

    englishSentenceEl.textContent = pair.english;
    originalChunks = getWordChunks(pair.french);
    currentChunkIndex = 0;

    updateLivesDisplay();
    cloudAreaWrapper.innerHTML = '';

    // reset rocket
    rocket.classList.remove('crash','launch','explode');
    rocket.style.transition = 'none';
    rocket.style.bottom = `5%`;
    rocket.style.opacity = 1;
    rocket.offsetHeight;
    rocket.style.transition = '';

    feedbackElement.classList.add('hide');
    nextButton.classList.add('hide');

    sentenceCounter.textContent = `${currentTextIndex+1}/${sentencePairs.length}`;
    displayNextWordOptions();
    startSentenceTimer();
}

/* ------------------------
   CLOUDS: NON-OVERLAPPING
-------------------------*/

function displayNextWordOptions() {
    cloudAreaWrapper.innerHTML = '';

    const correct = originalChunks[currentChunkIndex].join(' ');
    let options = [correct];

    while (options.length < 6) {
        let r = allFrenchWords[Math.floor(Math.random() * allFrenchWords.length)];
        if (!options.includes(r) && r.toLowerCase() !== correct.toLowerCase()) {
            options.push(r);
        }
    }
    shuffleArray(options);
    placeCloudsWithoutOverlap(options);

    // move rocket
    let p = (currentChunkIndex / originalChunks.length);
    rocket.style.bottom = (5 + p * 80) + '%';
}

function placeCloudsWithoutOverlap(options) {
    const placed = [];
    const width = cloudAreaWrapper.clientWidth;
    const height = cloudAreaWrapper.clientHeight;

    // left region: x 4%-16%
    // right region: x 66%-80%

    options.forEach((text, idx) => {
        let cloud = document.createElement('div');
        cloud.className = 'cloud-option';
        cloud.textContent = text;
        cloud.dataset.isCorrect = text === originalChunks[currentChunkIndex].join(' ');
        cloud.onclick = () => checkAnswer(cloud);

        cloudAreaWrapper.appendChild(cloud);

        let box;
        let tries = 0;
        while (true) {
            tries++;
            if (tries > 40) break;

            let isLeft = idx < 3;
            let leftPx = isLeft
                ? width * (0.04 + Math.random() * 0.12)
                : width * (0.66 + Math.random() * 0.14);

            let topPx = height * (0.10 + Math.random() * 0.70);

            cloud.style.left = leftPx + 'px';
            cloud.style.top = topPx + 'px';

            box = cloud.getBoundingClientRect();

            let overlap = placed.some(p => {
                return !(box.right < p.left ||
                         box.left > p.right ||
                         box.bottom < p.top ||
                         box.top > p.bottom);
            });

            if (!overlap) {
                placed.push(box);
                break;
            }
        }
    });
}

/* ------------------------
   ANSWERS
-------------------------*/

function checkAnswer(cloud) {
    if (isGameOver) return;

    if (cloud.dataset.isCorrect === 'true') {
        currentChunkIndex++;

        if (currentChunkIndex === originalChunks.length) {
            isGameOver = true;
            stopSentenceTimer();
            cloudAreaWrapper.innerHTML = '';
            rocket.style.bottom = '';

            triggerLaunch();

            setTimeout(() => {
                feedbackElement.textContent = 'Great launch!';
                feedbackElement.style.color = 'green';
                feedbackElement.classList.remove('hide');

                nextButton.classList.remove('hide');
            }, LAUNCHANIMATIONDURATION);

        } else {
            displayNextWordOptions();
        }

    } else {
        triggerFailure(cloud);
    }
}

/* ------------------------
   ANIMATIONS
-------------------------*/

function triggerLaunch() {
    rocket.classList.remove('launch');
    void rocket.offsetWidth;
    requestAnimationFrame(() => rocket.classList.add('launch'));
}

function triggerExplosion() {
    rocket.classList.remove('crash','launch');
    void rocket.offsetWidth;
    requestAnimationFrame(() => rocket.classList.add('explode'));
}

/* ------------------------
   FAILURE HANDLING
-------------------------*/

function triggerFailure(cloud) {
    if (isGameOver) return;
    isGameOver = true;
    stopSentenceTimer();

    if (cloud) cloud.classList.add('wrong');

    lives--;
    updateLivesDisplay();

    /* ----------- GAME OVER: EXPLOSION ----------- */
    if (lives <= 0) {
        feedbackElement.classList.add('hide'); // suppress retry message

        triggerExplosion();

        setTimeout(() => {
            gameScreen.style.display = 'none';
            endScreen.classList.remove('hide');
            document.getElementById('end-title').textContent = 'üí• Game Over üí•';
            document.getElementById('end-subtitle').textContent = 'The rocket exploded!';
        }, EXPLOSION_DURATION);

        return;
    }

    /* ----------- NORMAL WRONG ANSWER ----------- */
    rocket.classList.remove('crash');
    void rocket.offsetWidth;
    requestAnimationFrame(() => rocket.classList.add('crash'));

    feedbackElement.textContent = 'Oh no, wrong word! Try again.';
    feedbackElement.style.color = 'red';
    feedbackElement.classList.remove('hide');

    setTimeout(() => {
        if (cloud) cloud.classList.remove('wrong');
        displaySentence();
    }, CRASHANIMATIONDURATION);
}

/* ------------------------
   NAVIGATION
-------------------------*/
function nextText() {
    currentTextIndex++;
    displaySentence();
}

function resetActivity() {
    startGame();
}

/* ------------------------
   UTILITIES
-------------------------*/
function getWordChunks(t) {
    return t.split(/\s+/).filter(Boolean).map(w => [w]);
}

function shuffleArray(a) {
    for (let i=a.length-1;i>0;i--) {
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
}
</script>
</body>
</html>
