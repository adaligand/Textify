<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drag and Drop</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
    }
    .game-wrapper {
        background-color: white;
        padding: 20px 40px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 900px;
    }
    .game-content { width: 100%; padding: 20px; box-sizing: border-box; font-size: 20px; }
    .title { font-size: 40px; font-weight: bold; text-align: center; margin-bottom: 20px; }
    .subtitle { font-size: 20px; margin-bottom: 10px; text-align: center; }
    .counter { font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 10px; }
    
    /* ‚ú® NOUVEAU: Style pour le conteneur d'images */
    .image-clues {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .hint-img {
        max-width: 150px;
        max-height: 150px;
        object-fit: contain;
        border-radius: 8px;
        border: 1px solid #ddd;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
    }

    .draggable-word { display: inline-flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 5px; font-size: 20px; margin-bottom: 5px; border: 1px solid black; padding: 2px 10px; border-radius: 5px; background-color: #f0f0f0; height: 30px; line-height: 1.5; vertical-align: middle; }
    .dropzone { border: 1px dashed #007bff; min-width: 50px; min-height: 30px; font-size: 20px; border-radius: 10px; display: inline-block; padding: 5px 10px; vertical-align: middle; line-height: 1.5; margin-right: 5px; cursor: pointer; }
    .feedback-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
    .feedback { font-weight: bold; font-size: 18px; text-align: center; }
    button { padding: 10px 20px; background-color: #f9f9f9; border: 2px solid #ccc; color: #000; border-radius: 10px; cursor: pointer; }
    button:hover { background-color: #A9A9A9; transform: translateY(-4px); }
    .hide { display: none; }
</style>
</head>
<body>
<div class="game-wrapper">
    <div class="game-content">
      <div class="title">Drag and Drop</div>
      <div class="subtitle">Drag and drop the missing words to complete the sentence</div>
      <div class="counter" id="sentenceCounter"></div>

      <div id="imageContainer" class="image-clues"></div>

      <div id="exerciseOutput"></div>

      <div class="feedback-container">
        <div id="feedback" class="feedback hide"></div>
        <button id="nextButton" class="hide" onclick="nextText()">Next</button>
      </div>

      <div class="input-container">
        <button id="resetButton" class="hide" onclick="resetActivity()">Restart</button>
      </div>
    </div>
</div>

<script>
let allData = []; // ‚ú® Modifi√©: stocke des objets {sentence, images}
let randomizedSentences = [];
let currentTextIndex = 0;
let originalChunks = [];
let removedChunks = [];
let removedIndices = [];
let filledDropzonesCount = 0;

const params = new URLSearchParams(window.location.search);
const sheetUrl = params.get('sheet');

if (!sheetUrl) {
    document.querySelector('.game-content').innerHTML = "<h1>‚ö†Ô∏è No sheet URL provided.</h1>";
} else {
    Papa.parse(sheetUrl, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
            results.data.forEach((row, index) => {
                if (index === 0) return;
                // ‚ú® NOUVEAU: Extraction de la phrase (Col F) et des images (Col G)
                if (row[5] && row[5].trim()) {
                    let imageUrls = [];
                    if (row[6]) { // Colonne G (index 6)
                        imageUrls = row[6].split(',').map(url => url.trim());
                    }
                    allData.push({
                        sentence: row[5].trim(),
                        images: imageUrls
                    });
                }
            });

            if (allData.length === 0) {
                document.querySelector('.game-content').innerHTML = "<h1>‚ö†Ô∏è No data found.</h1>";
                return;
            }
            startGame();
        },
        error: function(err) {
            console.error(err);
            document.querySelector('.game-content').innerHTML = "<h1>‚ö†Ô∏è Error loading CSV file.</h1>";
        }
    });
}

function startGame() {
  randomizedSentences = shuffleArray([...allData]).slice(0, 10);
  currentTextIndex = 0;
  generateChunk();
}

function generateChunk() {
  const imageContainer = document.getElementById('imageContainer');
  const exerciseOutput = document.getElementById('exerciseOutput');
  
  if (currentTextIndex >= randomizedSentences.length) {
    imageContainer.innerHTML = ""; // Nettoyer les images
    exerciseOutput.innerHTML = "<h2>üéâ Well done!</h2>";
    document.getElementById('nextButton').classList.add('hide');
    document.getElementById('resetButton').classList.remove('hide');
    return;
  }

  const currentItem = randomizedSentences[currentTextIndex];
  const sentence = currentItem.sentence;
  
  // ‚ú® NOUVEAU: Affichage des images indices
  imageContainer.innerHTML = "";
  currentItem.images.forEach(url => {
      if(url) {
          const img = document.createElement('img');
          img.src = url;
          img.classList.add('hint-img');
          img.alt = "Clue";
          imageContainer.appendChild(img);
      }
  });

  originalChunks = sentence.split(' ').filter(Boolean);
  let numToRemove = Math.max(1, Math.floor(originalChunks.length / 3));
  removedIndices = getRandomIndices(originalChunks.length, numToRemove);
  removedChunks = removedIndices.map(i => originalChunks[i]);

  const sentenceDiv = document.createElement('div');
  sentenceDiv.style.textAlign = 'center';
  originalChunks.forEach((word, i) => {
    if (removedIndices.includes(i)) {
      sentenceDiv.innerHTML += `<div class="dropzone" data-index="${i}" ondrop="drop(event)" ondragover="allowDrop(event)"></div> `;
    } else {
      sentenceDiv.innerHTML += word + ' ';
    }
  });

  exerciseOutput.innerHTML = '';
  exerciseOutput.appendChild(sentenceDiv);

  const chunkContainer = document.createElement('div');
  chunkContainer.classList.add('chunk-container');
  chunkContainer.style.marginTop = '20px';
  chunkContainer.style.textAlign = 'center';
  shuffleArray([...removedChunks]).forEach((word) => { 
    // Correction: On cherche l'index parmi les mots enlev√©s
    const originalIndex = removedIndices.find(i => originalChunks[i] === word);
    const chunkElement = document.createElement('div');
    chunkElement.textContent = word;
    chunkElement.classList.add('draggable-word');
    chunkElement.setAttribute('draggable', 'true');
    chunkElement.setAttribute('ondragstart', 'drag(event)');
    chunkElement.setAttribute('data-original-index', originalIndex);
    chunkContainer.appendChild(chunkElement);
  });
  exerciseOutput.appendChild(chunkContainer);

  document.getElementById('feedback').classList.add('hide');
  document.getElementById('nextButton').classList.add('hide');
  filledDropzonesCount = 0;
  document.getElementById('sentenceCounter').textContent = (currentTextIndex + 1) + '/' + randomizedSentences.length;
}

// ... (Gardez le reste de vos fonctions : shuffleArray, getRandomIndices, drag, allowDrop, drop, etc. sans changement)

function nextText() {
  currentTextIndex++;
  generateChunk();
}

function resetActivity() {
  startGame();
  document.getElementById('resetButton').classList.add('hide');
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function getRandomIndices(length, count) {
  let indices = [];
  while (indices.length < count) {
    const i = Math.floor(Math.random() * length);
    if (!indices.includes(i)) indices.push(i);
  }
  return indices;
}

function drag(event) {
  event.dataTransfer.setData("text", event.target.textContent);
  event.dataTransfer.setData("original-index", event.target.getAttribute('data-original-index'));
}

function allowDrop(event) { event.preventDefault(); }

function drop(event) {
  event.preventDefault();
  const data = event.dataTransfer.getData("text");
  const idx = event.dataTransfer.getData("original-index");
  const target = event.target;

  if (target.classList.contains('dropzone') && !target.textContent) {
    target.textContent = data;
    target.setAttribute('data-original-index', idx);
    filledDropzonesCount++;
    removeDraggableWord(idx);
    checkAnswers();
  }
}

function removeDraggableWord(idx) {
  const container = document.querySelector('.chunk-container');
  const words = container.querySelectorAll('.draggable-word');
  for (let word of words) {
    if (word.getAttribute('data-original-index') === idx) {
        word.remove();
        break; // Supprime seulement une instance si le mot est en double
    }
  }
}

function addDraggableWord(word, idx) {
  const container = document.querySelector('.chunk-container');
  const chunkElement = document.createElement('div');
  chunkElement.textContent = word;
  chunkElement.classList.add('draggable-word');
  chunkElement.setAttribute('draggable', 'true');
  chunkElement.setAttribute('ondragstart', 'drag(event)');
  chunkElement.setAttribute('data-original-index', idx);
  container.appendChild(chunkElement);
}

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('dropzone') && e.target.textContent) {
    const word = e.target.textContent;
    const idx = e.target.getAttribute('data-original-index');
    e.target.textContent = '';
    filledDropzonesCount--;
    addDraggableWord(word, idx);
    document.getElementById('feedback').classList.add('hide');
  }
});

function checkAnswers() {
  const dropzones = document.querySelectorAll('.dropzone');
  if (filledDropzonesCount === dropzones.length) {
    let correct = 0;
    dropzones.forEach(dz => {
      const idx = dz.getAttribute('data-index');
      if (dz.textContent === originalChunks[idx]) correct++;
    });
    const feedback = document.getElementById('feedback');
    if (correct === dropzones.length) {
      feedback.textContent = "All answers are correct!";
      feedback.classList.remove('hide');
      document.getElementById('nextButton').classList.remove('hide');
    } else {
      feedback.textContent = `You have ${dropzones.length - correct} incorrect word(s). Click on a word to try again.`;
      feedback.classList.remove('hide');
    }
  }
}
</script>
</body>
</html>
