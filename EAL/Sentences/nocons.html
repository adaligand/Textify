<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>No Consonants</title> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
    /* Styles de base */
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
    }
    
    .game-wrapper {
        background-color: white;
        padding: 20px 40px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 900px;
    }
    
    .container { width: 100%; padding: 20px; box-sizing: border-box; font-size: 16px; }
    .title { font-size: 40px; font-weight: bold; text-align: center; margin-bottom: 20px; }
    .subtitle { font-size: 20px; margin-bottom: 10px; text-align: center; }
    .counter { font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 10px; }
    .sentence-wrapper { text-align: center; margin-bottom: 20px; }
    .sentence { display: inline-block; font-size: 24px; line-height: 1.6; }
    
    /* Conteneur d'images optimis√© pour 3 photos */
    .clue-container {
        text-align: center;
        margin-bottom: 20px;
        min-height: 120px; 
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px; 
        flex-wrap: wrap;
    }
    
    .clue-image {
        max-height: 120px; 
        max-width: 250px;   
        border: 2px solid #eee;
        border-radius: 10px;
        object-fit: cover;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* Champs de saisie */
    .missing-word { 
        width: 22px; 
        padding: 0; 
        font-size: 24px; 
        border: none; 
        border-bottom: 2px solid #333; 
        background-color: transparent; 
        outline: none; 
        margin-right: 2px; 
        text-align: center; 
        display: inline-block;
        font-family: monospace;
    }
    .correct { background-color: #cef4ce; color: green; border-bottom-color: green; }
    .incorrect { background-color: #ffb6c19c; color: red; border-bottom-color: red; }
    
    button { 
        padding: 10px 25px; 
        border-radius: 10px; 
        border: 2px solid #ccc; 
        background: #f9f9f9; 
        cursor: pointer; 
        margin-top: 20px;
        font-size: 20px;
        transition: all 0.2s;
    }
    button:hover { background-color: #e0e0e0; transform: translateY(-2px); }
    .hide { display: none; }
</style>
</head>
<body>

<div class="game-wrapper">
    <div class="container">
      <div class="title">No Consonants</div>
      <div class="subtitle">Fill in the sentence with the correct consonants.</div>
      
      <div class="counter" id="sentenceCounter"></div>
      <div id="exerciseOutput" class="sentence-wrapper"></div>
      <div style="text-align: center;">
          <button id="resetButton" class="hide" onclick="initializeExercise()">Restart Game</button>
      </div>
    </div>
</div>

<script>
var currentTextIndex = 0;
var allSentences = [];
var sentencePairs = []; 
var vowels = ['a','e','i','o','u','y'];

const params = new URLSearchParams(window.location.search);
const sheetUrl = params.get('sheet');

if (!sheetUrl) {
    document.querySelector('.container').innerHTML = "<h1>‚ö†Ô∏è No sheet URL provided in the address bar.</h1>";
} else {
    Papa.parse(sheetUrl, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
            results.data.forEach((row, index) => {
                if (index === 0) return; // Skip Header

                let sentence = row[5]; // Column F
                let clues = row[6] ? row[6].trim() : ''; // Column G

                if (sentence && sentence.trim()) {
                    allSentences.push({ 
                        sentence: sentence.trim(),
                        clues: clues  
                    });
                }
            });

            if (allSentences.length === 0) {
                document.querySelector('.container').innerHTML = "<h1>‚ö†Ô∏è No data found in Column F.</h1>";
                return;
            }
            initializeExercise();
        },
        error: function(err) {
            console.error(err);
            document.querySelector('.container').innerHTML = "<h1>‚ö†Ô∏è Error loading CSV file.</h1>";
        }
    });
}

function initializeExercise() {
  sentencePairs = shuffleArray([...allSentences]).slice(0, 10);
  currentTextIndex = 0;
  document.getElementById('resetButton').classList.add('hide');
  generateChunk();
}

function shuffleArray(array){
  for(var i=array.length-1;i>0;i--){
    var j=Math.floor(Math.random()*(i+1));
    [array[i],array[j]]=[array[j],array[i]];
  }
  return array;
}

function generateChunk(){
  if (currentTextIndex >= sentencePairs.length) {
      document.getElementById('exerciseOutput').innerHTML = "<h2>üéâ Well done! You finished the set.</h2>";
      document.getElementById('resetButton').classList.remove('hide');
      document.getElementById('sentenceCounter').textContent = "";
      return;
  }

  var sentenceObj = sentencePairs[currentTextIndex];
  var exerciseOutput = document.getElementById('exerciseOutput');
  exerciseOutput.innerHTML = '';

  // --- GESTION DES IMAGES (COLONNE G) ---
  if (sentenceObj.clues && sentenceObj.clues.trim() !== '') {
      var clueContainer = document.createElement('div');
      clueContainer.classList.add('clue-container');

      // S√©parer par virgule et nettoyer les URLs
      var imageUrls = sentenceObj.clues.split(',').map(url => url.trim()).filter(url => url.length > 0);

      imageUrls.forEach(url => {
          var img = document.createElement('img');
          
          // Encodage sp√©cial pour g√©rer les espaces dans les dossiers GitHub
          var encodedUrl = url.split('/').map(part => encodeURIComponent(part)).join('/')
                              .replace(/http%3A/g, 'http:')
                              .replace(/https%3A/g, 'https:');
          
          img.src = encodedUrl;
          img.alt = 'Clue';
          img.classList.add('clue-image');
          
          // S√©curit√© : si l'image ne charge pas, on ne l'affiche pas
          img.onerror = function() { this.style.display = 'none'; };

          clueContainer.appendChild(img);
      });
      
      exerciseOutput.appendChild(clueContainer);
  }

  // --- G√âN√âRATION DE LA PHRASE ---
  var sentenceDiv = document.createElement('div');
  sentenceDiv.classList.add('sentence');
  var sentenceWithInputs = '';

  for(var i=0; i < sentenceObj.sentence.length; i++){
    var char = sentenceObj.sentence[i];
    var isVowel = vowels.includes(char.toLowerCase());
    var isLetter = /[a-zA-Z]/.test(char);

    if(isLetter && !isVowel){
      sentenceWithInputs += `<input type="text" class="missing-word" maxlength="1" data-index="${i}" oninput="validateCharacter(this)">`;
    } else {
      sentenceWithInputs += char;
    }
  }
  
  sentenceDiv.innerHTML = sentenceWithInputs;

  // Bouton Next
  var nextBtn = document.createElement('button');
  nextBtn.id='nextButton';
  nextBtn.textContent='Next Sentence ‚Üí';
  nextBtn.onclick = nextText;
  nextBtn.classList.add('hide');
  
  exerciseOutput.appendChild(sentenceDiv);
  exerciseOutput.appendChild(document.createElement('br'));
  exerciseOutput.appendChild(nextBtn);

  document.getElementById('sentenceCounter').textContent = (currentTextIndex+1)+'/'+sentencePairs.length;

  var firstInput = sentenceDiv.querySelector('.missing-word');
  if(firstInput) firstInput.focus();
}

function validateCharacter(input){
  var index = input.getAttribute('data-index');
  var correctChar = sentencePairs[currentTextIndex].sentence[index];
  
  input.classList.remove('correct','incorrect');
  
  if(input.value.trim() === '') return;
  
  if(input.value.toLowerCase() === correctChar.toLowerCase()) {
      input.classList.add('correct');
      jumpToNextInput(input);
  } else {
      input.classList.add('incorrect');
  }

  checkAnswers();
}

function jumpToNextInput(input){
  var inputs = Array.from(document.querySelectorAll('.missing-word'));
  var currentIndex = inputs.indexOf(input);
  if (currentIndex > -1 && currentIndex < inputs.length - 1) {
      inputs[currentIndex + 1].focus();
  }
}

function jumpToPreviousInput(input){
  var inputs = Array.from(document.querySelectorAll('.missing-word'));
  var currentIndex = inputs.indexOf(input);
  if (currentIndex > 0) {
      var prevInput = inputs[currentIndex - 1];
      prevInput.focus();  
      prevInput.value='';  
      prevInput.classList.remove('correct','incorrect');
  }
}

document.addEventListener('keydown', function(e){
  var active = document.activeElement;
  if(active && active.classList.contains('missing-word')){
    if(e.key === 'Backspace' && active.value === ''){
      e.preventDefault();
      jumpToPreviousInput(active);
    }
  }
});

function checkAnswers(){
  var inputs = document.querySelectorAll('.missing-word');
  var allCorrect = true;
  inputs.forEach(i => { if(!i.classList.contains('correct')) allCorrect = false; });
  
  var nextBtn = document.getElementById('nextButton');
  if(allCorrect) {
      nextBtn.classList.remove('hide');
      nextBtn.focus();
  } else {
      nextBtn.classList.add('hide');
  }
}

function nextText(){
  currentTextIndex++;
  generateChunk();
}
</script>

</body>
</html>
