<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unjumble</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
    /* ‚úÖ Styles de base et mise en page */
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
    }
    .game-wrapper {
        background-color: white;
        padding: 20px 40px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 900px;
    }
    .container { width: 100%; padding: 20px; box-sizing: border-box; font-size: 16px; }
    .title { font-size: 40px; font-weight: bold; text-align: center; margin-bottom: 20px; }
    .subtitle { font-size: 20px; margin-bottom: 10px; text-align: center; }
    .counter { font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 10px; }
    
    /* ‚úÖ Styles pour les images d'indices GitHub */
    .clue-container {
        text-align: center;
        margin-bottom: 20px;
        min-height: 120px; 
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    .clue-image {
        max-height: 120px; 
        max-width: 250px;   
        border: 2px solid #eee;
        border-radius: 10px;
        object-fit: cover;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* Styles pour le jeu de glisser-d√©poser */
    .draggable-word { 
        display: inline-flex; 
        align-items: center; 
        justify-content: center; 
        cursor: pointer; 
        margin: 5px; 
        font-size: 20px; 
        border: 2px solid #007bff; 
        padding: 8px 15px; 
        border-radius: 8px; 
        background-color: #f0f7ff; 
        transition: all 0.2s;
    }
    .draggable-word:hover { background-color: #e0efff; transform: scale(1.05); }
    
    .correct-chunk { background-color: #d4edda !important; border-color: #28a745 !important; color: #155724; }
    .wrong-chunk { background-color: #f8d7da !important; border-color: #dc3545 !important; animation: shake 0.5s; }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    .dropzone-container { margin-top: 20px; margin-bottom: 20px; text-align: center; min-height: 50px; }
    .dropzone { border: 2px dashed #ccc; min-height: 40px; min-width: 60px; font-size: 22px; border-radius: 10px; display: inline-block; padding: 5px 12px; vertical-align: middle; margin: 5px; background: #fafafa; }
    
    .feedback-container { text-align: center; margin-top: 20px; }
    .feedback { font-weight: bold; font-size: 18px; color: #28a745; margin-bottom: 10px; }
    
    button { padding: 10px 25px; background-color: #f9f9f9; border: 2px solid #ccc; border-radius: 10px; cursor: pointer; font-size: 18px; }
    button:hover { background-color: #e0e0e0; transform: translateY(-2px); }
    .hide { display: none; }
    #exerciseOutput { text-align: center; margin-bottom: 20px; border-top: 1px solid #eee; padding-top: 20px; }
</style>
</head>
<body>

<div class="game-wrapper">
    <div class="container">
      <div class="title">Unjumble</div>
      <div class="subtitle">Click the words in the correct order</div>
      
      <div class="counter" id="sentenceCounter"></div>

      <div id="clueOutput"></div>

      <div id="dropZones" class="dropzone-container"></div>
      
      <div id="exerciseOutput"></div>

      <div class="feedback-container">
        <div id="feedback" class="feedback hide">üéâ Perfect Order!</div>
        <button id="nextButton" class="hide" onclick="nextText()">Next Sentence ‚Üí</button>
      </div>

      <div style="text-align: center;">
        <button id="resetButton" class="hide" onclick="resetActivity()">Restart Game</button>
      </div>
    </div>
</div>

<script>
let allData = [];
let randomizedSentences = [];
let currentTextIndex = 0;
let originalChunks = [];
let currentChunkIndex = 0;

const params = new URLSearchParams(window.location.search);
const sheetUrl = params.get('sheet');

if (!sheetUrl) {
    document.querySelector('.container').innerHTML = "<h1>‚ö†Ô∏è No sheet URL provided.</h1>";
} else {
    Papa.parse(sheetUrl, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
            results.data.forEach((row, index) => {
                if (index === 0) return; // Skip header
                // Stocker phrase (F) et indices (G)
                if (row[5] && row[5].trim()) {
                    allData.push({
                        sentence: row[5].trim(),
                        clues: row[6] ? row[6].trim() : ''
                    });
                }
            });

            if (allData.length === 0) {
                document.querySelector('.container').innerHTML = "<h1>‚ö†Ô∏è No data found in Column F.</h1>";
                return;
            }
            startGame();
        }
    });
}

function startGame() {
  randomizedSentences = shuffleArray([...allData]).slice(0, 10);
  currentTextIndex = 0;
  generateChunk();
}

function generateChunk() {
  if (currentTextIndex >= randomizedSentences.length) {
    document.getElementById('dropZones').innerHTML = "<h2>üéâ Well done! You've finished.</h2>";
    document.getElementById('exerciseOutput').innerHTML = "";
    document.getElementById('clueOutput').innerHTML = "";
    document.getElementById('nextButton').classList.add('hide');
    document.getElementById('resetButton').classList.remove('hide');
    document.getElementById('sentenceCounter').textContent = "";
    return;
  }

  const currentItem = randomizedSentences[currentTextIndex];
  
  // 1. Affichage des images d'indices (Colonne G)
  const clueOutput = document.getElementById('clueOutput');
  clueOutput.innerHTML = '';
  if (currentItem.clues) {
      const clueContainer = document.createElement('div');
      clueContainer.classList.add('clue-container');
      
      const imageUrls = currentItem.clues.split(',').map(url => url.trim()).filter(url => url.length > 0);
      imageUrls.forEach(url => {
          const img = document.createElement('img');
          const encodedUrl = url.split('/').map(part => encodeURIComponent(part)).join('/')
                              .replace(/http%3A/g, 'http:').replace(/https%3A/g, 'https:');
          img.src = encodedUrl;
          img.classList.add('clue-image');
          img.onerror = function() { this.style.display = 'none'; };
          clueContainer.appendChild(img);
      });
      clueOutput.appendChild(clueContainer);
  }

  // 2. Pr√©paration des mots (Colonne F)
  originalChunks = currentItem.sentence.split(/\s+/).filter(Boolean);
  const shuffledChunks = shuffleArray([...originalChunks]);

  const dropZones = document.getElementById('dropZones');
  dropZones.innerHTML = '';
  originalChunks.forEach(() => {
    const dropZone = document.createElement('div');
    dropZone.classList.add('dropzone');
    dropZones.appendChild(dropZone);
  });

  const exerciseOutput = document.getElementById('exerciseOutput');
  exerciseOutput.innerHTML = '';
  shuffledChunks.forEach(word => {
    const wordElement = document.createElement('div');
    wordElement.textContent = word;
    wordElement.classList.add('draggable-word');
    wordElement.setAttribute('onclick', 'selectChunk(this)');
    exerciseOutput.appendChild(wordElement);
  });

  document.getElementById('feedback').classList.add('hide');
  document.getElementById('nextButton').classList.add('hide');
  currentChunkIndex = 0;
  document.getElementById('sentenceCounter').textContent = (currentTextIndex + 1) + '/' + randomizedSentences.length;
}

function selectChunk(element) {
  const clickedWord = element.textContent;
  const correctWord = originalChunks[currentChunkIndex];

  if (clickedWord === correctWord) {
    const dropZone = document.getElementById('dropZones').children[currentChunkIndex];
    dropZone.textContent = clickedWord;
    dropZone.classList.add('correct-chunk');
    dropZone.style.borderStyle = "solid";
    element.style.visibility = "hidden"; // On cache le mot au lieu de le supprimer pour √©viter les sauts de mise en page
    currentChunkIndex++;
    
    if (currentChunkIndex === originalChunks.length) {
      document.getElementById('feedback').classList.remove('hide');
      document.getElementById('nextButton').classList.remove('hide');
      document.getElementById('nextButton').focus();
    }
  } else {
    element.classList.add('wrong-chunk');
    setTimeout(() => element.classList.remove('wrong-chunk'), 500);
  }
}

function nextText() {
  currentTextIndex++;
  generateChunk();
}

function resetActivity() {
  document.getElementById('resetButton').classList.add('hide');
  startGame();
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}
</script>
</body>
</html>
