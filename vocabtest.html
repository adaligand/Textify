<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Test Hub</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* General Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            font-size: 22px;
            margin: 0;
            padding: 20px;
        }
        .container {
            width: 95%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }
        h1 { text-align: center; color: #2c3e50; }
        .hide { display: none !important; }
        #loading-message { text-align: center; }

        /* --- Selection Screen Styles --- */
        #vocab-selection-screen {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 50px 0;
            flex-grow: 1;
        }
        .selection-tile {
            flex: 0 0 45%; /* Two tiles per row */
            min-width: 300px;
            background-color: #2980b9;
            color: white;
            padding: 40px 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .selection-tile:hover {
            background-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        /* --- Quiz Body Styles (Retained) --- */
        .main-content-wrapper { display: flex; gap: 30px; margin-top: 20px; flex-grow: 1; }
        .test-panel { flex-grow: 1; }
        .controls-panel { flex: 0 0 300px; display: flex; flex-direction: column; gap: 15px; }
        .controls-panel .control-group { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        label { font-weight: bold; }
        select, button { width: 100%; font-size: 1em; padding: 12px 15px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background-color: #2980b9; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #3498db; }
        #reveal-btn { background-color: #27ae60; }
        #reveal-btn:hover { background-color: #2ecc71; }
        #print-btn { background-color: #8e44ad; }
        #print-btn:hover { background-color: #9b59b6; }
        table { width: 100%; border-collapse: collapse; font-size: 1.4em; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; overflow-wrap: break-word; }
        th { background-color: #f9f9f9; }
        th:first-child, td.num-cell { width: 60px; text-align: center; }
        td.num-cell { font-weight: bold; color: #7f8c8d; }
        .answer-cell span { visibility: hidden; color: #27ae60; font-weight: bold; }
        .answer-cell span.visible { visibility: visible; }
        
        /* --- PRINT STYLES --- */
        @media print {
            @page { size: landscape; margin: 1cm; }
            body { font-size: 10pt; padding: 0; margin: 0; background: white !important; }
            /* Hide everything that is NOT the print area */
            .container > :not(#print-area) { display: none !important; }
            .container { padding: 0 !important; margin: 0 !important; width: 100% !important; max-width: none !important; }
            
            #print-area {
                display: flex !important;
                justify-content: space-around;
                gap: 20px;
                width: 100%;
                padding: 10px; /* Space from page edge */
            }
            .print-table-wrapper {
                width: 48%;
                page-break-inside: avoid;
                box-sizing: border-box;
            }
            #print-area table { 
                font-size: 14pt; 
                border-collapse: collapse; 
                width: 100%; 
                table-layout: fixed;
            }
            #print-area th, #print-area td { 
                border: 1px solid #000; 
                padding: 8px; 
            }
            #print-area .answer-cell span { visibility: hidden !important; } 
            #print-area th:first-child, #print-area td.num-cell { width: 60px; text-align: center; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="main-title">Vocabulary Test Hub</h1>

    <div id="vocab-selection-screen">
        <div class="selection-tile" data-quiz-type="GCSE French">GCSE French üá´üá∑</div>
        <div class="selection-tile" data-quiz-type="GCSE German">GCSE German üá©üá™</div>
        <div class="selection-tile" data-quiz-type="AS French">AS French üá´üá∑</div>
        <div class="selection-tile" data-quiz-type="A2 French">A2 French üá´üá∑</div>
    </div>
    
    <div id="quiz-wrapper" class="hide">
        <p id="loading-message" style="text-align:center;">Loading sets from your spreadsheet...</p>

        <div class="main-content-wrapper">
            <div class="test-panel">
                <div id="test-container" class="hide">
                    <table>
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Target Language</th>
                                <th>English</th>
                            </tr>
                        </thead>
                        <tbody id="test-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="controls-panel">
                <h1 id="title">Vocabulary Test</h1>
                <div id="setup-controls" class="control-group hide">
                    <label for="theme-select">1. Choose Theme:</label><select id="theme-select"></select>
                    <label for="set-select">2. Choose Set:</label><select id="set-select"></select>
                    <label for="set-select-2">3. 2nd set (Optional):</label><select id="set-select-2"></select>
                    <button id="generate-btn">Generate List</button>
                </div>
                <div id="test-controls" class="control-group hide">
                    <button id="reveal-btn">Reveal Answers</button>
                    <button id="print-btn">üñ®Ô∏è Print Test</button>
                </div>
            </div>
        </div>
        <button id="back-to-hub-btn" style="margin-top: 20px;">Back to Selection</button>
    </div>
    
    <div id="print-area" class="hide"></div>
</div>

<script>
    // üõë CONFIGURATION: SPREADSHEET URLs üõë
    // REPLACE 'YOUR_..._SHEET_URL' with your actual public Google Sheet CSV links.
    const spreadsheetUrls = {
        'GCSE French': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSCNeq329ih6SxLZ2TowPzpk61gJLFy-UAVAb8ivBs9DNEOdmtRQ29bWh__n53MdE-C8hs_XOV3iIkT/pub?output=csv', 
        'GCSE German': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTlddh1-sO5-s5CPJt_a1H1ltX9orRCFvosUPVBJIqjxXc0nB3c4-f19sUNF5s6lIof7TnBIevleWJA/pub?output=csv',
        'AS French':   'YOUR_AS_FRENCH_SHEET_URL',     // <--- REPLACE THIS
        'A2 French':   'YOUR_A2_FRENCH_SHEET_URL'      // <--- REPLACE THIS
    };

    // --- DOM Elements ---
    const selectionScreen = document.getElementById('vocab-selection-screen');
    const quizWrapper = document.getElementById('quiz-wrapper');
    const mainTitle = document.getElementById('main-title');
    const loadingMessage = document.getElementById('loading-message');
    const setupControls = document.getElementById('setup-controls');
    const themeSelect = document.getElementById('theme-select');
    const setSelect = document.getElementById('set-select');
    const setSelect2 = document.getElementById('set-select-2');
    const generateBtn = document.getElementById('generate-btn');
    const testContainer = document.getElementById('test-container');
    const testBody = document.getElementById('test-body');
    const testControls = document.getElementById('test-controls');
    const revealBtn = document.getElementById('reveal-btn');
    const printBtn = document.getElementById('print-btn');
    const printArea = document.getElementById('print-area');
    const backToHubBtn = document.getElementById('back-to-hub-btn');

    // Structure: { 'Topic Name': { 'Set Number': [{target: 'x', english: 'y'}, ...] } }
    let vocabSets = {}; 

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const sheetUrl = params.get('sheet');
        const quizType = params.get('type');

        if (sheetUrl && quizType) {
            // QUIZ MODE
            selectionScreen.classList.add('hide');
            quizWrapper.classList.remove('hide');
            mainTitle.textContent = `${quizType} Vocabulary Test`;
            loadVocabData(sheetUrl);
        } else {
            // SELECTION MODE
            quizWrapper.classList.add('hide');
            selectionScreen.classList.remove('hide');
            mainTitle.textContent = "Select Your Vocabulary Set";
            
            // Set up tile click handlers
            document.querySelectorAll('.selection-tile').forEach(tile => {
                const type = tile.dataset.quizType;
                if (spreadsheetUrls[type] && !spreadsheetUrls[type].includes('YOUR_')) {
                    tile.addEventListener('click', () => {
                        window.location.href = `?sheet=${encodeURIComponent(spreadsheetUrls[type])}&type=${encodeURIComponent(type)}`;
                    });
                } else {
                    tile.style.opacity = '0.5';
                    tile.title = "URL not set in the code.";
                }
            });
        }
        
        // Event Listeners for Quiz Controls
        generateBtn.addEventListener('click', generateTest);
        revealBtn.addEventListener('click', revealAnswers);
        themeSelect.addEventListener('change', updateSetDropdown); 
        printBtn.addEventListener('click', () => window.print());
        backToHubBtn.addEventListener('click', () => window.location.href = window.location.pathname); 
    });

    // --- DATA LOADING (Corrected to handle sparse data) ---
    function loadVocabData(url) {
        Papa.parse(url, {
            download: true, header: false, skipEmptyLines: true,
            complete: (results) => {
                let currentTopicName = null;
                let currentSetNumber = null; // New variable to hold the last seen set number
                vocabSets = {}; // Reset sets

                results.data.forEach(row => {
                    const topicInRow = row[0] ? row[0].trim() : '';      // Column A: Topic Name
                    const setNumberInRow = row[1] ? row[1].trim() : '';  // Column B: Set Number
                    const targetWord = row[3] ? row[3].trim() : '';      // Column D: Target Language
                    const englishWord = row[4] ? row[4].trim() : '';     // Column E: English

                    // 1. UPDATE CURRENT TOPIC AND SET NUMBER

                    // If a Topic Name is found in Column A, update currentTopicName
                    if (topicInRow !== '') {
                        currentTopicName = topicInRow;
                        if (!vocabSets[currentTopicName]) {
                            vocabSets[currentTopicName] = {};
                        }
                    }

                    // If a Set Number is found in Column B, update currentSetNumber
                    if (setNumberInRow !== '') {
                        currentSetNumber = setNumberInRow;
                    }
                    
                    // 2. STORE VOCAB WORD

                    // Only store the word if we have a valid topic, a set number, and the actual words
                    if (currentTopicName && currentSetNumber && targetWord !== '' && englishWord !== '') {
                        // Ensure the set structure exists under the current topic
                        if (!vocabSets[currentTopicName][currentSetNumber]) {
                             vocabSets[currentTopicName][currentSetNumber] = [];
                        }
                        // Add the word to the current set
                        vocabSets[currentTopicName][currentSetNumber].push({ target: targetWord, english: englishWord });
                    }
                });
                
                if (Object.keys(vocabSets).length > 0) {
                    initializeSelectors();
                    loadingMessage.classList.add('hide');
                    setupControls.classList.remove('hide');
                } else {
                    loadingMessage.textContent = "‚ö†Ô∏è No vocabulary sets found. Check Columns A, B, D, and E.";
                    alert("‚ö†Ô∏è No vocabulary sets found. Returning to selection screen.");
                    window.location.href = window.location.pathname;
                }
            },
            error: () => { 
                loadingMessage.textContent = "‚ö†Ô∏è Failed to load spreadsheet."; 
                alert("‚ö†Ô∏è Failed to load spreadsheet. Check the URL and public sharing settings. Returning to selection screen.");
                window.location.href = window.location.pathname;
            }
        });
    }
    
    // --- QUIZ LOGIC ---

    function initializeSelectors() {
        const topicNames = Object.keys(vocabSets);
        themeSelect.innerHTML = '';
        
        topicNames.sort().forEach(topic => {
            const option = document.createElement('option');
            option.value = topic;
            option.textContent = topic;
            themeSelect.appendChild(option);
        });

        if(topicNames.length === 0) {
            themeSelect.innerHTML = '<option>No Topics Loaded</option>';
            return;
        }

        // CRITICAL FIX: Load the sets for the default selected theme
        updateSetDropdown();
    }

    function updateSetDropdown() {
        // Use the currently selected theme, or default to the first available topic if none selected.
        const selectedTopic = themeSelect.value || Object.keys(vocabSets)[0]; 

        setSelect.innerHTML = '';
        setSelect2.innerHTML = '';

        const noneOption = document.createElement('option');
        noneOption.value = "";
        noneOption.textContent = "-- None --";
        setSelect2.appendChild(noneOption);

        if (!selectedTopic || !vocabSets[selectedTopic]) {
            setSelect.innerHTML = '<option>-- Select a Theme --</option>';
            return;
        }

        const setsInTopic = Object.keys(vocabSets[selectedTopic]).sort((a, b) => {
            // Smart sort to handle set numbers like '1.10' vs '1.2'
            const numA = parseFloat(a);
            const numB = parseFloat(b);
            if (numA !== numB) return numA - numB;
            return a.localeCompare(b);
        });


        setsInTopic.forEach(setNumber => {
            const wordCount = vocabSets[selectedTopic][setNumber].length;
            
            const option1 = document.createElement('option');
             option1.value = setNumber;
             option1.textContent = `${setNumber} (${wordCount} words)`;
             setSelect.appendChild(option1);
             
             const option2 = option1.cloneNode(true);
             setSelect2.appendChild(option2);
        });
    }

    function generateTest() {
        const selectedTopic = themeSelect.value;
        const selectedSetNumber1 = setSelect.value;
        const selectedSetNumber2 = setSelect2.value;
        
        if (!selectedSetNumber1 || !selectedTopic) return;

        let combinedSet = [...vocabSets[selectedTopic][selectedSetNumber1]];
        if (selectedSetNumber2 && selectedSetNumber2 !== "") {
            combinedSet = combinedSet.concat(vocabSets[selectedTopic][selectedSetNumber2]);
        }
        
        const uniqueCombinedSet = Array.from(new Map(combinedSet.map(item => [item.target, item])).values());
        if (uniqueCombinedSet.length === 0) return;

        const shuffled = [...uniqueCombinedSet].sort(() => 0.5 - Math.random());
        
        // Generate a test list of 10 words total (5 Target->English, 5 English->Target)
        const targetQuestionItems = shuffled.slice(0, 5); 
        const englishQuestionItems = shuffled.slice(5, 10);

        testBody.innerHTML = '';
        
        // Generate Target Language to English questions
        targetQuestionItems.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="num-cell">${index + 1}</td>
                <td>${item.target}</td>
                <td class="answer-cell"><span class="answer">${item.english}</span></td>
            `;
            testBody.appendChild(row);
        });

        // Generate English to Target Language questions
        englishQuestionItems.forEach((item, index) => {
            const row = document.createElement('tr');
            const rowNumber = targetQuestionItems.length + index + 1;
            row.innerHTML = `
                <td class="num-cell">${rowNumber}</td>
                <td class="answer-cell"><span class="answer">${item.target}</span></td>
                <td>${item.english}</td>
            `;
            testBody.appendChild(row);
        });
        
        // Setup print area with two copies of the table
        const onScreenTable = document.querySelector('#test-container table');
        const tableToPrint = onScreenTable.cloneNode(true); 
        
        // Ensure no answers are visible on the print version
        tableToPrint.querySelectorAll('.answer').forEach(span => span.classList.remove('visible'));
        
        const tableHeaderHTML = tableToPrint.querySelector('thead').outerHTML;
        const tableBodyHTML = tableToPrint.querySelector('tbody').innerHTML;
        const fullTableHTML = `<table>${tableHeaderHTML}${tableBodyHTML}</table>`;

        printArea.innerHTML = `
            <div class="print-table-wrapper">${fullTableHTML}</div>
            <div class="print-table-wrapper">${fullTableHTML}</div>
        `;
        
        testContainer.classList.remove('hide');
        testControls.classList.remove('hide');
        revealBtn.textContent = 'Reveal Answers';
        document.querySelectorAll('.answer').forEach(span => span.classList.remove('visible'));
    }

    function revealAnswers() {
        const answers = document.querySelectorAll('.answer');
        if (answers.length === 0) return;
        
        const isHidden = !answers[0].classList.contains('visible');
        answers.forEach(span => {
            span.classList.toggle('visible', isHidden);
        });

        revealBtn.textContent = isHidden ? 'Hide Answers' : 'Reveal Answers';
    }

</script>

</body>
</html>
