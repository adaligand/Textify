<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gapfillator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5; /* Light grey background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            width: 90%; /* Set width to 90% of the screen */
            max-width: 1200px; /* Added a max-width for very large screens */
            padding: 40px;
            box-sizing: border-box;
            background-color: white; /* White background for the game */
            border-radius: 15px; /* Rounded corners */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            text-align: center;
        }
        .subtitle {
            font-size: 20px;
            margin-bottom: 10px;
        }
        .english-text-box {
            margin-bottom: 20px;
            font-size: 20px;
            text-align: justify;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        button {
            padding: 10px 20px;
            background-color: #f9f9f9;
            color: #000000;
            border: 2px solid #ccc;
            border-radius: 10px;
            cursor: pointer;
        }
        button:hover {
            background-color: #A9A9A9;
            transform: translateY(-4px);
        }
        .hide {
            display: none;
        }
        #exerciseOutput {
            font-size: 20px;
            line-height: 2.5;
            text-align: justify;
        }
        .filled-word {
            display: inline-block;
            margin: 0 3px;
            padding: 5px 8px;
            vertical-align: bottom;
            height: 30px;
            line-height: 1;
            font-size: 20px;
            font-family: inherit;
            text-align: center;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #feedback {
            margin-top: 10px;
            font-weight: bold;
            display: inline-block;
            vertical-align: middle;
        }
        .keyboard-container {
            margin-top: 20px;
            text-align: center;
        }
        .keyboard-button {
            font-size: 18px;
            padding: 10px 15px;
            margin: 2px;
            border: none;
            border-radius: 10px;
            background-color: #f0f0f0;
            color: #000000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .keyboard-button:hover {
            background-color: #A9A9A9;
            transform: translateY(-4px);
        }
        .title {
            font-size: 40px;
            font-weight: bold;
            text-align: center;
        }
        select {
            width: auto;
            padding: 5px;
            border-radius: 10px;
            margin-bottom: 10px;
            height: 35px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">Gapfillator</div>
        <br><br>
        <div class="subtitle" id="subtitle">Gapfill: Select the amount of words to remove from the text and your language keyboard, then click on Generate exercise.</div>
        
        <div class="english-text-box hide" id="englishTextBox">
            <div id="englishText"></div>
        </div>
        <div id="frenchText" class="hide"></div>
        
        <label for="percentageSelect">Select the amount of words to remove:</label>
        <select id="percentageSelect">
            <option value="aFewWords">A few words</option>
            <option value="someWords">Some words</option>
            <option value="moreWords">More words</option>
            <option value="half">Half</option>
            <option value="evenMoreWords">Even more words</option>
        </select>
        <select id="languageSelect">
            <option value="french" selected>French</option>
            <option value="german">German</option>
            <option value="spanish">Spanish</option>
        </select>
        <button onclick="generateExercise()">Generate Exercise</button>
        <div id="exerciseOutput" class="hide"></div>
        <div id="checkFeedbackContainer" class="hide">
            <button id="checkButton" onclick="checkExercise()">Check Exercise</button>
            <div id="feedback" class="hide"></div>
        </div>
        <button id="resetButton" class="hide" onclick="resetExercise()">Reset</button>

        <div class="keyboard-container" id="keyboardContainer"></div>
    </div>

<script>
    let focusedInput = null;

    const params = new URLSearchParams(window.location.search);
    const sheetUrl = params.get('sheet');

    if (!sheetUrl) {
        document.getElementById('subtitle').textContent = "⚠️ No CSV URL provided. Please add ?sheet=YOUR_LINK to the address bar.";
    } else {
        document.getElementById('subtitle').textContent = "Loading data...";
        Papa.parse(sheetUrl, {
            download: true,
            header: false,
            skipEmptyLines: false,
            complete: function(results) {
                try {
                    const frenchText = results.data[1][8];
                    const englishText = results.data[4][8];

                    if (!frenchText || !englishText) {
                        throw new Error("Text is missing from cell I2 or I5.");
                    }
                    
                    document.getElementById('frenchText').textContent = frenchText.trim();
                    document.getElementById('englishText').textContent = englishText.trim();
                    document.getElementById('englishTextBox').classList.remove('hide');

                    document.getElementById('subtitle').textContent = "Gapfill: Select the amount of words to remove, then click 'Generate Exercise'.";
                    
                    initialize();

                } catch (e) {
                    document.getElementById('subtitle').textContent = "⚠️ Error reading data. Check that your sheet has text in cells I2 and I5 and is published correctly.";
                    console.error(e);
                }
            },
            error: function(err) {
                document.getElementById('subtitle').textContent = "⚠️ Error loading the CSV file.";
                console.error(err);
            }
        });
    }

    function initialize() {
        document.getElementById('languageSelect').value = 'french';
        generateKeyboard('french');
        document.addEventListener('focusin', function(event) {
            if (event.target.classList.contains('filled-word')) {
                focusedInput = event.target;
            }
        });
    }

    function generateKeyboard(language) {
        var keyboardContainer = document.getElementById('keyboardContainer');
        keyboardContainer.innerHTML = '';
        var characters = [];
        switch (language) {
            case 'german': characters = ['ä', 'ö', 'ü', 'ß']; break;
            case 'french': characters = ['à', 'â', 'ä','é', 'è', 'ê', 'ë', 'î', 'ï', 'ô','ö', 'ù', 'ü', 'û', 'ç']; break;
            case 'spanish': characters = ['á', 'é', 'í', 'ó', 'ú', 'ñ']; break;
        }
        characters.forEach(function (character) {
            var button = document.createElement('button');
            button.textContent = character;
            button.className = 'keyboard-button';
            button.onclick = function() { insertCharacter(character); };
            keyboardContainer.appendChild(button);
        });
    }
    
    document.getElementById('languageSelect').addEventListener('change', function () {
        generateKeyboard(this.value);
    });

    function generateExercise() {
        generateFillBlanksExercise();
    }

    function generateFillBlanksExercise() {
        document.getElementById('subtitle').style.display = 'none';
        document.getElementById('exerciseOutput').innerHTML = '';
        document.getElementById('checkFeedbackContainer').classList.add('hide');

        var textInputValue = document.getElementById('frenchText').textContent;
        var selectValue = document.getElementById('percentageSelect').value;
        var percentage;

        switch (selectValue) {
            case "aFewWords": percentage = 5; break;
            case "someWords": percentage = 10; break;
            case "moreWords": percentage = 20; break;
            case "half": percentage = 50; break;
            case "evenMoreWords": percentage = 60; break;
            default: alert("Invalid selection."); return;
        }

        var words = textInputValue.match(/[\wÀ-ÿ'-]+|[^\s\wÀ-ÿ'-]+/g) || [];
        var uniqueWords = Array.from(new Set(words.filter(word => word.length > 1)));
        var numWordsToRemove = Math.min(Math.round((percentage / 100) * uniqueWords.length), uniqueWords.length);

        if (numWordsToRemove < 1) {
            alert("Not enough unique words to remove for this percentage.");
            return;
        }
        
        uniqueWords = shuffle(uniqueWords);
        var removedWords = uniqueWords.slice(0, numWordsToRemove);
        
        var modifiedText = '';
        textInputValue.split(/([\wÀ-ÿ'-]+)/g).forEach(function(part) {
            if (removedWords.includes(part)) {
                modifiedText += '<input type="text" class="filled-word" data-correct-answer="' + part + '" oninput="updateCheckingButtonVisibility()">';
            } else {
                modifiedText += part;
            }
        });

        var exerciseOutput = document.getElementById('exerciseOutput');
        exerciseOutput.innerHTML = modifiedText;
        exerciseOutput.classList.remove('hide');
        
        resetFeedback();
    }
    
    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function updateCheckingButtonVisibility() {
        var checkButton = document.getElementById('checkButton');
        if (checkFilledInputs()) {
            checkButton.parentNode.classList.remove('hide');
        } else {
            checkButton.parentNode.classList.add('hide');
        }
    }

    function checkFilledInputs() {
        var filledInputs = document.getElementsByClassName('filled-word');
        for (var i = 0; i < filledInputs.length; i++) {
            if (filledInputs[i].value.trim() === '') {
                return false;
            }
        }
        return true;
    }

    function checkExercise() {
        var filledInputs = document.getElementsByClassName('filled-word');
        var feedback = document.getElementById('feedback');
        var incorrectCount = 0;

        for (var i = 0; i < filledInputs.length; i++) {
            var correctAnswer = filledInputs[i].dataset.correctAnswer;
            if (filledInputs[i].value.trim().toLowerCase() !== correctAnswer.toLowerCase()) {
                incorrectCount++;
                filledInputs[i].style.backgroundColor = '#f8d7da'; // red
            } else {
                filledInputs[i].style.backgroundColor = '#d4edda'; // green
            }
        }

        if (incorrectCount === 0) {
            feedback.textContent = 'All answers are correct!';
            feedback.style.color = 'green';
            document.getElementById('resetButton').classList.remove('hide');
        } else {
            feedback.textContent = 'Number of incorrect answers: ' + incorrectCount;
            feedback.style.color = 'red';
            document.getElementById('resetButton').classList.add('hide');
        }
        feedback.classList.remove('hide');
    }

    function resetFeedback() {
        var feedback = document.getElementById('feedback');
        feedback.textContent = '';
        feedback.classList.add('hide');
    }

    function resetExercise() {
        document.getElementById('exerciseOutput').innerHTML = '';
        document.getElementById('exerciseOutput').classList.add('hide');
        document.getElementById('feedback').classList.add('hide');
        document.getElementById('feedback').textContent = '';
        document.getElementById('resetButton').classList.add('hide');
        document.getElementById('checkFeedbackContainer').classList.add('hide');
        document.getElementById('subtitle').style.display = 'block';
    }

    function insertCharacter(character) {
        if (focusedInput) {
            var start = focusedInput.selectionStart;
            var end = focusedInput.selectionEnd;
            var text = focusedInput.value;
            focusedInput.value = text.substring(0, start) + character + text.substring(end);
            focusedInput.selectionStart = focusedInput.selectionEnd = start + 1;
            focusedInput.focus();
            updateCheckingButtonVisibility();
        }
    }
</script>
</body>
</html>
