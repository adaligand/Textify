<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>First letter</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5; /* Light grey background */
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
    }
    .container {
        width: 100%;
        max-width: 1000px; /* Constrain width on large screens */
        padding: 40px;
        box-sizing: border-box;
        background-color: white; /* White background for the game */
        border-radius: 15px; /* Rounded corners */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        text-align: center;
    }
    .title {
        font-size: 40px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
    }
    .subtitle {
        font-size: 20px;
        margin-bottom: 10px;
    }
    .english-sentence {
        margin-bottom: 20px;
        font-size: 20px;
        padding: 10px;
        border: 2px solid #ccc;
        border-radius: 10px;
        background-color: #f9f9f9;
        text-align: center;
    }
    .french-sentence {
        margin-bottom: 20px;
        font-size: 20px;
    }
    .missing-word {
        width: 15px;
        padding: 0px;
        font-size: 20px;
        border: none;
        border-bottom: 0.5px solid #000000;
        background-color: transparent;
        outline: none;
        margin-right: 2px;
        text-align: center;
    }
    .correct {
        background-color: #cef4ce;
    }
    .incorrect {
        background-color: #ffb6c19c;
    }
    .feedback {
        font-weight: bold;
        font-size: 24px;
        text-align: center;
        margin-top: 20px;
    }
    #keyboardContainer {
        text-align: center;
        margin-top: 20px;
    }
    .keyboard-button {
        font-size: 18px;
        padding: 10px 15px;
        margin: 2px;
        border: none;
        border-radius: 10px;
        background-color: #f0f0f0;
        color: #000000;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: background-color 0.3s, transform 0.2s;
    }
    .keyboard-button:hover {
        background-color: #A9A9A9;
        transform: translateY(-4px);
    }
    select {
        width: auto;
        padding: 5px;
        border-radius: 10px;
        margin-bottom: 10px;
        height: 35px;
    }
    .hide {
        display: none;
    }
</style>
</head>
<body>
    <div class="container">
        <div class="title">First letter only</div>
        <div class="subtitle" id="subtitle">Loading exercise...</div>
        <br>
        
        <div id="exerciseOutput"></div>
        <div class="input-container">
            <select id="languageSelect" onchange="generateKeyboard(this.value)">
                <option value="french" selected>French</option>
                <option value="german">German</option>
                <option value="spanish">Spanish</option>
            </select>
            <div id="feedback" class="feedback hide">ðŸŽ‰ Correct! Well done. ðŸŽ‰</div>
            <br>
            <div id="keyboardContainer"></div>
        </div>
    </div>

    <script>
        var lastFocusedInput = null;
        var currentFrenchSentence = ''; // Will hold the single French sentence
        var punctuations = [',', '!', '?', '.', ';', ':'];

        // --- DATA LOADING LOGIC ---
        const params = new URLSearchParams(window.location.search);
        const sheetUrl = params.get('sheet');

        if (!sheetUrl) {
            document.getElementById('subtitle').textContent = "âš ï¸ No sheet URL provided. Add ?sheet=YOUR_CSV_LINK to the end of the URL.";
        } else {
            Papa.parse(sheetUrl, {
                download: true,
                header: false, // Treat the sheet as a grid, not a table
                skipEmptyLines: false, // Preserve row positions
                complete: function(results) {
                    try {
                        // Access data by coordinates: results.data[rowIndex][columnIndex]
                        // Cell I2 is row index 1, column index 8
                        const frenchText = results.data[1][8];
                        // Cell I5 is row index 4, column index 8
                        const englishText = results.data[4][8];

                        if (!frenchText || !englishText) {
                            throw new Error("Text is missing from cell I2 or I5.");
                        }
                        
                        // Store the sentence and start the game
                        currentFrenchSentence = frenchText.trim();
                        document.getElementById('subtitle').textContent = "Fill in the sentence with the correct letters.";
                        generateKeyboard('french');
                        generateChunk(currentFrenchSentence, englishText.trim());

                    } catch (e) {
                        console.error("Data Parsing Error:", e);
                        document.getElementById('subtitle').textContent = "âš ï¸ Error reading data. Ensure your sheet has text in cells I2 and I5 and is published correctly.";
                    }
                },
                error: function(err) {
                    console.error("CSV Loading Error:", err);
                    document.getElementById('subtitle').textContent = "âš ï¸ Error loading or parsing the CSV file.";
                }
            });
        }

        function insertCharacter(character) {
            if (lastFocusedInput) {
                lastFocusedInput.value = character;
                validateCharacter(lastFocusedInput);
            }
        }

        function generateKeyboard(language) {
            var keyboardContainer = document.getElementById('keyboardContainer');
            keyboardContainer.innerHTML = '';
            var characters = [];
            switch (language) {
                case 'german':
                    characters = ['Ã¤', 'Ã¶', 'Ã¼', 'ÃŸ'];
                    break;
                case 'french':
                    characters = ['Ã ', 'Ã¢', 'Ã¤', 'Ã©', 'Ã¨', 'Ãª', 'Ã«', 'Ã®', 'Ã¯', 'Ã´', 'Ã¶', 'Ã¹', 'Ã¼', 'Ã»', 'Ã§'];
                    break;
                case 'spanish':
                    characters = ['Ã¡', 'Ã©', 'Ã­', 'Ã³', 'Ãº', 'Ã±'];
                    break;
            }
            characters.forEach(function(character) {
                var button = document.createElement('button');
                button.innerHTML = character;
                button.className = 'keyboard-button';
                button.setAttribute('type', 'button');
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    insertCharacter(character);
                });
                keyboardContainer.appendChild(button);
            });
        }

        function generateChunk(frenchSentence, englishSentence) {
            var sentenceWithInputFields = '';
            var words = frenchSentence.split(' ');
            let globalCharIndex = 0;

            words.forEach((word) => {
                if (word.includes("'")) {
                    let parts = word.split("'");
                    sentenceWithInputFields += parts[0] + "'";
                    let part1Index = frenchSentence.indexOf(parts[1], globalCharIndex + parts[0].length);
                    for (let i = 0; i < parts[1].length; i++) {
                        sentenceWithInputFields += `<input type="text" maxlength="1" class="missing-word" data-index="${part1Index + i}" oninput="validateCharacter(this)" onfocus="setLastFocusedInput(this)" onkeydown="handleKeyDown(event, this)">`;
                    }
                } else {
                    sentenceWithInputFields += word.charAt(0);
                    let firstCharIndex = frenchSentence.indexOf(word, globalCharIndex);
                    for (let i = 1; i < word.length; i++) {
                        if (punctuations.includes(word[i])) {
                            sentenceWithInputFields += word[i];
                        } else {
                            sentenceWithInputFields += `<input type="text" maxlength="1" class="missing-word" data-index="${firstCharIndex + i}" oninput="validateCharacter(this)" onfocus="setLastFocusedInput(this)" onkeydown="handleKeyDown(event, this)">`;
                        }
                    }
                }
                globalCharIndex += word.length + 1;
                sentenceWithInputFields += " ";
            });

            var exerciseOutput = document.getElementById('exerciseOutput');
            exerciseOutput.innerHTML = `
                <div class="english-sentence">${englishSentence}</div>
                <div class="french-sentence">${sentenceWithInputFields.trim()}</div>
            `;
        }

        function setLastFocusedInput(input) {
            lastFocusedInput = input;
        }

        function handleKeyDown(event, input) {
            if (event.key === "Enter") {
                let nextInput = findNextInput(input);
                if (nextInput) nextInput.focus();
                event.preventDefault();
            } else if (event.key === "Backspace" && input.value === '') {
                let prevInput = findPrevInput(input);
                if (prevInput) {
                    prevInput.focus();
                }
                event.preventDefault();
            }
        }

        function findNextInput(currentInput) {
            let allInputs = Array.from(document.querySelectorAll('.missing-word'));
            let currentIndex = allInputs.indexOf(currentInput);
            return allInputs[currentIndex + 1] || null;
        }

        function findPrevInput(currentInput) {
            let allInputs = Array.from(document.querySelectorAll('.missing-word'));
            let currentIndex = allInputs.indexOf(currentInput);
            return allInputs[currentIndex - 1] || null;
        }

        function validateCharacter(input) {
            var userInput = input.value.trim().toLowerCase();
            var correctChar = currentFrenchSentence[input.getAttribute('data-index')];
            
            if (userInput === '') {
                input.classList.remove('correct', 'incorrect');
            } else if (userInput === correctChar.toLowerCase()) {
                input.classList.add('correct');
                input.classList.remove('incorrect');
                let nextInput = findNextInput(input);
                if (nextInput) {
                    nextInput.focus();
                }
            } else {
                input.classList.add('incorrect');
                input.classList.remove('correct');
            }
            
            checkAllAnswers();
        }

        function checkAllAnswers() {
            var inputFields = document.querySelectorAll('.missing-word');
            var allCorrect = Array.from(inputFields).every(input => input.classList.contains('correct'));

            if (allCorrect) {
                document.getElementById('feedback').classList.remove('hide');
            } else {
                document.getElementById('feedback').classList.add('hide');
            }
        }
    </script>
</body>
</html>
