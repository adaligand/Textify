<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Languaged Hub</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;}
    .container {width: 100%; max-width: 1400px; background: #fff; padding: 25px 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);}
    h1, h2 {text-align: center; color: #333;}
    .hide {display: none !important;}
    #main-menu {text-align: center;}
    #main-menu .menu-buttons {display: flex; justify-content: center; gap: 20px; margin-top: 30px;}
    .menu-button {font-size: 1.2em; padding: 20px 40px; border-radius: 10px; border: none; color: white; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;}
    .menu-button:hover {transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.15);}
    #reading-btn {background-color: #2980b9;} #listening-btn {background-color: #27ae60;} #vocab-btn {background-color: #8e44ad;}
    button {border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; padding: 12px 20px; transition: background-color 0.2s ease, transform 0.1s ease; white-space: nowrap;}
    button:hover {transform: translateY(-2px);}
    .btn-primary {background-color: #2980b9; color: #fff;} .btn-primary:hover {background-color: #3498db;}
    .btn-secondary {background-color: #6c757d; color: white;} .btn-secondary:hover {background-color: #5a6268;}
    .practice-controls {display: flex; gap: 15px; margin-bottom: 25px; align-items: flex-end; flex-wrap: wrap;}
    .practice-control-group {flex-grow: 1; min-width: 200px; display: flex; flex-direction: column;}
    label {font-weight: 600; margin-bottom: 8px; color: #606770;}
    select {font-size: 16px; padding: 12px; border-radius: 8px; border: 1px solid #dddfe2; background-color: #f5f6f7;}
    #question-display {border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; min-height: 400px; background-color: #fafafa;}
    #question-display iframe {width: 100%; height: 500px; border-radius: 8px; border: none;}
    .vocab-main-wrapper {display: flex; gap: 30px; margin-top: 20px;}
    .vocab-test-panel {flex-grow: 1;}
    .vocab-controls-panel {flex: 0 0 300px; display: flex; flex-direction: column; gap: 15px;}
    .vocab-control-group {background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 15px;}
    #vocab-test-container table {width: 100%; border-collapse: collapse; font-size: 1.4em; table-layout: fixed;}
    #vocab-test-container th, #vocab-test-container td {border: 1px solid #ddd; padding: 12px; text-align: left;}
    #vocab-test-container th:first-child, #vocab-test-container td.num-cell {width: 60px; text-align: center;}
    #vocab-test-container th:nth-child(2), #vocab-test-container td:nth-child(2), #vocab-test-container th:nth-child(3), #vocab-test-container td:nth-child(3) {width: 47%;}
    .answer-cell span {visibility: hidden; color: #27ae60; font-weight: bold;}
    .answer-cell span.visible {visibility: visible;}
  </style>
</head>
<body>
<div class="container">
  <div id="main-menu">
    <h1>Language Practice Hub</h1>
    <p>Please choose an activity</p>
    <div class="menu-buttons">
      <button id="reading-btn" class="menu-button">Reading Practice</button>
      <button id="listening-btn" class="menu-button">Listening Practice</button>
      <button id="vocab-btn" class="menu-button">Vocabulary Test</button>
    </div>
  </div>

  <div id="practice-section" class="hide">
    <h1 id="practice-title">Practice Section</h1>
    <input type="hidden" id="current-practice-type" value="">
    <div class="practice-controls">
      <div class="practice-control-group">
        <label for="topic-select">Choose a Theme:</label>
        <select id="topic-select"><option>Loading Themes...</option></select>
      </div>
      <div class="practice-control-group">
        <label for="question-select">Choose a Question:</label>
        <select id="question-select"><option>Select a Theme first...</option></select>
      </div>
      <button id="generate-practice-btn" class="btn-primary">Load Question</button>
      <button id="fullscreen-btn" class="btn-primary hide">üîà Open Full Screen</button>
      <button class="btn-primary back-btn">Back to Main Menu</button>
    </div>
    <div id="question-display">
      <h2>Your question will appear here</h2>
      <p>Select a theme and question, then click "Load Question".</p>
    </div>
  </div>

  <div id="vocab-section" class="hide">
    <div class="vocab-main-wrapper">
      <div class="vocab-test-panel">
        <div id="vocab-test-container" class="hide">
          <table>
            <thead><tr><th>No.</th><th>Target Language</th><th>English</th></tr></thead>
            <tbody id="vocab-test-body"></tbody>
          </table>
          <div id="vocab-test-controls" class="hide" style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
            <button id="vocab-reveal-btn" class="btn-primary">Reveal Answers</button>
            <button id="vocab-print-btn" class="btn-primary">üñ®Ô∏è Print Test</button>
            <button class="btn-primary back-btn">Back to Main Menu</button>
          </div>
        </div>
      </div>
      <div class="vocab-controls-panel" id="vocab-controls-panel">
        <h1>Vocabulary Test</h1>
        <div id="vocab-setup-controls" class="vocab-control-group">
          <label for="vocab-theme-select">Choose Theme:</label><select id="vocab-theme-select"></select>
          <label for="vocab-set-select">Choose Set:</label><select id="vocab-set-select"></select>
          <label for="vocab-set-select-2">2nd set (Optional):</label><select id="vocab-set-select-2"></select>
          <button id="vocab-generate-btn" class="btn-primary">Generate List</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const practiceSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRvNFlHDx-4cZbDzwKy5Yb_DKeSxS2wSXxyX1Ua6pGcf27yFjmqOPz9jQ_rzoV3-zoZI9lw4EIfmdXH/pub?output=csv";
const vocabSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCNeq329ih6SxLZ2TowPzpk61gJLFy-UAVAb8ivBs9DNEOdmtRQ29bWh__n53MdE-C8hs_XOV3iIkT/pub?output=csv";
let practice_allQuestions = [];
let vocab_vocabSets = {};

const mainMenu = document.getElementById('main-menu');
const practiceSection = document.getElementById('practice-section');
const vocabSection = document.getElementById('vocab-section');
const readingBtn = document.getElementById('reading-btn');
const listeningBtn = document.getElementById('listening-btn');
const vocabBtn = document.getElementById('vocab-btn');
const practice_topicSelect = document.getElementById('topic-select');
const practice_questionSelect = document.getElementById('question-select');
const practice_generateBtn = document.getElementById('generate-practice-btn');
const practice_questionDisplay = document.getElementById('question-display');
const fullscreenBtn = document.getElementById('fullscreen-btn');
const vocab_themeSelect = document.getElementById('vocab-theme-select');
const vocab_setSelect = document.getElementById('vocab-set-select');
const vocab_setSelect2 = document.getElementById('vocab-set-select-2');
const vocab_generateBtn = document.getElementById('vocab-generate-btn');
const vocab_testContainer = document.getElementById('vocab-test-container');
const vocab_testBody = document.getElementById('vocab-test-body');
const vocab_testControls = document.getElementById('vocab-test-controls');
const vocab_revealBtn = document.getElementById('vocab-reveal-btn');

readingBtn.addEventListener('click', () => showPractice('Reading'));
listeningBtn.addEventListener('click', () => showPractice('Listening'));
vocabBtn.addEventListener('click', showVocabTest);
document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', showMainMenu));

function showMainMenu(){mainMenu.classList.remove('hide');practiceSection.classList.add('hide');vocabSection.classList.add('hide');}
function showPractice(type){mainMenu.classList.add('hide');practiceSection.classList.remove('hide');vocabSection.classList.add('hide');document.getElementById('practice-title').textContent = `${type} Practice`;currentPracticeTypeInput.value = type;practice_populateTopics();}
function showVocabTest(){mainMenu.classList.add('hide');practiceSection.classList.add('hide');vocabSection.classList.remove('hide');}

function loadData(url, options){return new Promise((resolve,reject)=>{Papa.parse(url,{...options,download:true,skipEmptyLines:true,complete:(r)=>resolve(r.data),error:(e)=>reject(e)});});}

async function initializeApp(){
  const [practiceData, vocabData] = await Promise.all([
    loadData(practiceSheetUrl, { header: true }),
    loadData(vocabSheetUrl, { header: false })
  ]);
  practice_allQuestions = practiceData.map(q => ({
    Skill: q.Skill,
    Theme: q.Theme,
    Question: q.Question,
    Content: q.Content
  })).filter(q => q.Skill && q.Theme && q.Content);

  vocab_vocabSets = {};
  let currentTheme = null, currentSet = null;
  vocabData.forEach(row => {
    const theme = row[0]?.trim();
    const set = row[1]?.trim();
    const target = row[3]?.trim();
    const english = row[4]?.trim();
    if(theme) currentTheme = theme;
    if(currentTheme && set){
      const key = `${currentTheme}.${set}`;
      if(!vocab_vocabSets[key]) vocab_vocabSets[key] = [];
      if(target && english) vocab_vocabSets[key].push({target, english});
    }
  });
  vocab_initializeSelectors();
}

practice_topicSelect.addEventListener('change', practice_populateQuestions);
practice_generateBtn.addEventListener('click', practice_generateQuestion);

function practice_populateTopics(){
  const selectedType = currentPracticeTypeInput.value;
  const themes = [...new Set(practice_allQuestions.filter(q=>q.Skill===selectedType).map(q=>q.Theme))];
  practice_topicSelect.innerHTML = '<option value="">-- Select Theme --</option>';
  themes.sort().forEach(theme=>{
    const opt=document.createElement('option');opt.value=theme;opt.textContent=theme;practice_topicSelect.appendChild(opt);
  });
  practice_populateQuestions();
}

function practice_populateQuestions(){
  const selectedTheme = practice_topicSelect.value;
  const selectedType = currentPracticeTypeInput.value;
  const questions = practice_allQuestions.filter(q=>q.Skill===selectedType && q.Theme===selectedTheme);
  practice_questionSelect.innerHTML='';
  if(questions.length===0){practice_questionSelect.innerHTML='<option>No Questions Available</option>';return;}
  questions.forEach(q=>{
    const opt=document.createElement('option');opt.value=q.Content;opt.textContent=q.Question;practice_questionSelect.appendChild(opt);
  });
}

function practice_generateQuestion(){
  const url = practice_questionSelect.value;
  if(!url){practice_questionDisplay.innerHTML="<h2>Select a question first.</h2>";return;}
  const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  const fileId = match ? match[1] : null;
  if(fileId){
    const embedUrl = `https://docs.google.com/presentation/d/${fileId}/embed?start=false&loop=false`;
    const presentUrl = `https://docs.google.com/presentation/d/${fileId}/present`;
    practice_questionDisplay.innerHTML = `<iframe src="${embedUrl}" allowfullscreen></iframe>`;
    fullscreenBtn.classList.remove('hide');
    fullscreenBtn.onclick = ()=>window.open(presentUrl,'_blank');
  } else {
    practice_questionDisplay.innerHTML = `<iframe src="${url}" allowfullscreen></iframe>`;
  }
}

function vocab_initializeSelectors(){
  const themes = [...new Set(Object.keys(vocab_vocabSets).map(k=>k.split('.')[0]))];
  vocab_themeSelect.innerHTML='<option value="">-- Select Theme --</option>';
  themes.sort().forEach(theme=>{
    const opt=document.createElement('option');opt.value=theme;opt.textContent=theme;vocab_themeSelect.appendChild(opt);
  });
  vocab_themeSelect.addEventListener('change', vocab_updateSetDropdown);
}

function vocab_updateSetDropdown(){
  const theme = vocab_themeSelect.value;
  vocab_setSelect.innerHTML='';vocab_setSelect2.innerHTML='<option value="">-- None --</option>';
  if(!theme) return;
  const sets = Object.keys(vocab_vocabSets).filter(k=>k.startsWith(theme+'.'));
  sets.forEach(set=>{
    const opt=document.createElement('option');
    opt.value=set;opt.textContent=set.split('.')[1];
    vocab_setSelect.appendChild(opt);
    vocab_setSelect2.appendChild(opt.cloneNode(true));
  });
}

vocab_generateBtn.addEventListener('click', vocab_generateTest);
vocab_revealBtn.addEventListener('click', vocab_revealAnswers);
document.getElementById('vocab-print-btn').addEventListener('click', ()=>window.print());

function vocab_generateTest(){
  const set1=vocab_setSelect.value; if(!set1) return;
  let words=[...vocab_vocabSets[set1]];
  const set2=vocab_setSelect2.value;
  if(set2) words=words.concat(vocab_vocabSets[set2]);
  const unique=Array.from(new Map(words.map(i=>[i.target,i])).values());
  vocab_testBody.innerHTML='';
  unique.slice(0,10).forEach((item,i)=>{
    const row=vocab_testBody.insertRow();
    if(i<5) row.innerHTML=`<td class="num-cell">${i+1}</td><td>${item.target}</td><td class="answer-cell"><span>${item.english}</span></td>`;
    else row.innerHTML=`<td class="num-cell">${i+1}</td><td class="answer-cell"><span>${item.target}</span></td><td>${item.english}</td>`;
  });
  vocab_testContainer.classList.remove('hide');
  vocab_testControls.classList.remove('hide');
  document.querySelectorAll('#vocab-test-container .answer-cell span').forEach(s=>s.classList.remove('visible'));
}

function vocab_revealAnswers(){
  const spans=document.querySelectorAll('#vocab-test-container .answer-cell span');
  const reveal=!spans[0]?.classList.contains('visible');
  spans.forEach(s=>s.classList.toggle('visible',reveal));
  vocab_revealBtn.textContent=reveal?'Hide Answers':'Reveal Answers';
}

initializeApp();
</script>
</body>
</html>
