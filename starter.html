
<!DOCTYPE html>
<html lang="en">
<head>a
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Language  Hub</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f0f2f5;
      color: #1c1e21;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 1400px;
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h1, h2 { text-align: center; color: #333; }
    .hide { display: none !important; }

    /* --- MENU --- */
    #main-menu { text-align: center; }
    #main-menu .menu-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    .menu-button {
      font-size: 1.2em;
      padding: 20px 40px;
      border-radius: 10px;
      border: none;
      color: white;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .menu-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }
    #reading-btn { background-color: #2980b9; }
    #listening-btn { background-color: #27ae60; }
    #vocab-btn { background-color: #8e44ad; }

    /* --- BUTTON STYLE --- */
    button {
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      padding: 12px 20px;
      transition: background-color 0.2s ease, transform 0.1s ease;
      white-space: nowrap;
    }
    button:hover { transform: translateY(-2px); }
    .btn-primary { background-color: #2980b9; color: #fff; }
    .btn-primary:hover { background-color: #3498db; }
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background-color: #5a6268;
    }

    /* --- PRACTICE --- */
    .practice-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      align-items: flex-end;
      flex-wrap: wrap; /* Allows wrapping on smaller screens */
    }
    .practice-control-group {
      flex-grow: 1;
      min-width: 200px; /* Ensure selection boxes have a decent size */
      display: flex;
      flex-direction: column;
    }
    label { font-weight: 600; margin-bottom: 8px; color: #606770; }
    select {
      font-size: 16px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #dddfe2;
      background-color: #f5f6f7;
    }
    #question-display {
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      min-height: 400px;
      background-color: #fafafa;
    }
    #question-display iframe {
      width: 100%;
      height: 500px;
      border-radius: 8px;
      border: none;
    }

    /* --- VOCAB --- */
    .vocab-main-wrapper { display: flex; gap: 30px; margin-top: 20px; }
    .vocab-test-panel { flex-grow: 1; }
    .vocab-controls-panel {
      flex: 0 0 300px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .vocab-control-group {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    #vocab-test-container table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.4em;
      table-layout: fixed; /* FIX for equal column spreading */
    }
    #vocab-test-container th, #vocab-test-container td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    /* Column 1: Number (Fixed width) */
    #vocab-test-container th:first-child,
    #vocab-test-container td.num-cell {
      width: 60px;
      text-align: center;
    }
    /* Column 2 & 3: Target and English (Equal width) */
    #vocab-test-container th:nth-child(2),
    #vocab-test-container td:nth-child(2),
    #vocab-test-container th:nth-child(3),
    #vocab-test-container td:nth-child(3) {
      width: 47%; 
    }

    .answer-cell span { visibility: hidden; color: #27ae60; font-weight: bold; }
    .answer-cell span.visible { visibility: visible; }

    /* --- PRINT --- */
    @media print {
        /* Set page to landscape and adjust margins */
        @page { size: A4 landscape; margin: 1cm; }
        
        /* Hide all user interface elements */
        .container, #main-menu, #practice-section, #vocab-controls-panel { display: none !important; }
        
        /* Show only the vocab section for printing */
        #vocab-section { 
            display: block !important; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            padding: 0; 
            margin: 0;
        }

        /* --- Quiz Grid Styling --- */
        #vocab-test-container {
            /* KEY FIX: Forces display even if it has the .hide class */
            display: block !important; 
            width: 100%;
            /* Suggests a two-column print layout */
            column-count: 2;
            column-gap: 20px;
        }

        /* Apply table styling for print */
        #vocab-test-container table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11pt; 
            page-break-inside: avoid; 
            margin-bottom: 20px;
            table-layout: fixed;
        }
        
        #vocab-test-container th, #vocab-test-container td { 
            border: 1px solid #000; 
            padding: 5px 8px; 
            line-height: 1.2; 
        }

        /* Ensure column widths are maintained in print */
        #vocab-test-container th:first-child,
        #vocab-test-container td.num-cell {
            width: 50px; /* slightly smaller for print */
        }
        #vocab-test-container th:nth-child(2),
        #vocab-test-container td:nth-child(2),
        #vocab-test-container th:nth-child(3),
        #vocab-test-container td:nth-child(3) {
            width: calc(50% - 25px); /* Adjusted for the 50px number column */
        }
        
        /* Ensure answers are hidden for the blank quiz printout */
        .answer-cell span { 
            visibility: hidden !important; 
        }
    }
  </style>
</head>
<body>
<div class="container">
  <div id="main-menu">
    <h1>Language Practice Hub</h1>
    <p>Please choose an activity</p>
    <div class="menu-buttons">
      <button id="reading-btn" class="menu-button">Reading Practice</button>
      <button id="listening-btn" class="menu-button">Listening Practice</button>
      <button id="vocab-btn" class="menu-button">Vocabulary Test</button>
    </div>
  </div>

  <div id="practice-section" class="hide">
    <h1 id="practice-title">Practice Section</h1>
    <input type="hidden" id="current-practice-type" value="">
    <div class="practice-controls">
      <div class="practice-control-group">
        <label for="topic-select">Choose a Theme:</label>
        <select id="topic-select"><option>Loading Themes...</option></select>
      </div>
      <!-- NEW QUESTION SELECTOR -->
      <div class="practice-control-group">
        <label for="question-select">Choose a Question:</label>
        <select id="question-select"><option>Select a Theme first...</option></select>
      </div>
      <!-- END NEW QUESTION SELECTOR -->
      <button id="generate-practice-btn" class="btn-primary">Load Question</button>
      <button id="fullscreen-btn" class="btn-primary hide">üîà Open Full Screen</button>
      <button class="btn-primary back-btn">Back to Main Menu</button>
    </div>
    <div id="question-display">
      <h2>Your question will appear here</h2>
      <p>Select a theme and question, then click "Load Question".</p>
    </div>
  </div>

  <div id="vocab-section" class="hide">
    <div class="vocab-main-wrapper">
      <div class="vocab-test-panel">
        <div id="vocab-test-container" class="hide">
          <table>
            <thead><tr><th>No.</th><th>Target Language</th><th>English</th></tr></thead>
            <tbody id="vocab-test-body"></tbody>
          </table>
        </div>
        <div id="vocab-print-area" class="hide"></div>
      </div>
      <div class="vocab-controls-panel" id="vocab-controls-panel">
        <h1>Vocabulary Test</h1>
        <div id="vocab-setup-controls" class="vocab-control-group">
          <label for="vocab-theme-select">1. Choose Theme:</label><select id="vocab-theme-select"></select>
          <label for="vocab-set-select">2. Choose Set:</label><select id="vocab-set-select"></select>
          <label for="vocab-set-select-2">3. 2nd set (Optional):</label><select id="vocab-set-select-2"></select>
          <button id="vocab-generate-btn" class="btn-primary">Generate List</button>
        </div>
        <div id="vocab-test-controls" class="vocab-control-group hide">
          <button id="vocab-reveal-btn" class="btn-primary">Reveal Answers</button>
          <button id="vocab-print-btn" class="btn-primary">üñ®Ô∏è Print Test</button>
        </div>
        <button class="btn-primary back-btn">Back to Main Menu</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- URLs and Global Variables ---
const practiceSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRvNFlHDx-4cZbDzwKy5Yb_DKeSxS2wSXxyX1Ua6pGcf27yFjmqOPz9jQ_rzoV3-zoZI9lw4EIfmdXH/pub?output=csv";
const vocabSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCNeq329ih6SxLZ2TowPzpk61gJLFy-UAVAb8ivBs9DNEOdmtRQ29bWh__n53MdE-C8hs_XOV3iIkT/pub?output=csv";
let practice_allQuestions = [];
let vocab_vocabSets = {};

// --- DOM Element References ---
const mainMenu = document.getElementById('main-menu');
const practiceSection = document.getElementById('practice-section');
const vocabSection = document.getElementById('vocab-section');
const readingBtn = document.getElementById('reading-btn');
const listeningBtn = document.getElementById('listening-btn');
const vocabBtn = document.getElementById('vocab-btn');
const currentPracticeTypeInput = document.getElementById('current-practice-type');

const practice_topicSelect = document.getElementById('topic-select'); // Theme Selector
const practice_questionSelect = document.getElementById('question-select'); // NEW Question Selector
const practice_generateBtn = document.getElementById('generate-practice-btn');

const practice_questionDisplay = document.getElementById('question-display');
const fullscreenBtn = document.getElementById('fullscreen-btn');
const vocab_themeSelect = document.getElementById('vocab-theme-select');
const vocab_setSelect = document.getElementById('vocab-set-select');
const vocab_setSelect2 = document.getElementById('vocab-set-select-2');
const vocab_generateBtn = document.getElementById('vocab-generate-btn');
const vocab_testContainer = document.getElementById('vocab-test-container');
const vocab_testBody = document.getElementById('vocab-test-body');
const vocab_testControls = document.getElementById('vocab-test-controls');
const vocab_revealBtn = document.getElementById('vocab-reveal-btn');
const vocab_printArea = document.getElementById('vocab-print-area');

// --- Navigation ---
readingBtn.addEventListener('click', () => showPractice('Reading'));
listeningBtn.addEventListener('click', () => showPractice('Listening'));
vocabBtn.addEventListener('click', showVocabTest);
document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', showMainMenu));

function showMainMenu() {
    mainMenu.classList.remove('hide');
    practiceSection.classList.add('hide');
    vocabSection.classList.add('hide');
}

function showPractice(type) {
    mainMenu.classList.add('hide');
    practiceSection.classList.remove('hide');
    vocabSection.classList.add('hide');
    document.getElementById('practice-title').textContent = `${type} Practice`;
    currentPracticeTypeInput.value = type;
    practice_populateTopics();
}

function showVocabTest() {
    mainMenu.classList.add('hide');
    practiceSection.classList.add('hide');
    vocabSection.classList.remove('hide');
}

// --- Data Loading ---
function loadData(url, options) {
    return new Promise((resolve, reject) => {
        Papa.parse(url, {
            ...options,
            download: true,
            skipEmptyLines: true,
            complete: (results) => resolve(results.data),
            error: (err) => reject(err),
        });
    });
}

async function initializeApp() {
    readingBtn.disabled = true;
    listeningBtn.disabled = true;
    vocabBtn.disabled = true;
    readingBtn.textContent = 'Loading...';

    try {
        const [practiceData, vocabData] = await Promise.all([
            loadData(practiceSheetUrl, { header: true }),
            loadData(vocabSheetUrl, { header: false })
        ]);

        // Renaming columns based on new structure: A=Skill, B=Theme, C=Question, D=Content
        practice_allQuestions = practiceData.map(q => ({
            Skill: q.Skill,
            Theme: q.Theme,
            Question: q.Question,
            Content: q.Content
        })).filter(q => q.Skill && q.Theme && q.Content);


        vocab_vocabSets = {};
        let currentTheme = null; 
        let currentKey = null;
        let currentWords = [];

        vocabData.forEach(row => {
            if (!row || row.length < 5) return; 

            const themeInRow = row[0]?.trim();
            const set = row[1]?.trim();
            const target = row[3]?.trim();
            const english = row[4]?.trim();

            if (themeInRow) {
                currentTheme = themeInRow;
            }

            if (currentTheme && set) {
                if (currentKey && currentWords.length > 0) {
                    vocab_vocabSets[currentKey] = currentWords;
                }
                currentKey = `${currentTheme}.${set}`;
                currentWords = [];
            }

            if (currentKey && target && english) {
                currentWords.push({ target, english });
            }
        });

        if (currentKey && currentWords.length > 0) {
            vocab_vocabSets[currentKey] = currentWords;
        }
        
        vocab_initializeSelectors();

        readingBtn.disabled = false;
        listeningBtn.disabled = false;
        vocabBtn.disabled = false;
        readingBtn.textContent = 'Reading Practice';

    } catch (error) {
        console.error("Failed to load spreadsheet data:", error);
        document.querySelector('.container').innerHTML = '<h1>Error</h1><p>Could not load data from the spreadsheets. Please check the URLs and make sure the sheets are published correctly.</p>';
    }
}

// --- Practice Section Logic ---
practice_topicSelect.addEventListener('change', practice_populateQuestions);
practice_generateBtn.addEventListener('click', practice_generateQuestion);

function practice_populateTopics() {
    const selectedType = currentPracticeTypeInput.value;
    // Use column B: Theme
    const themes = [...new Set(practice_allQuestions.filter(q => q.Skill === selectedType).map(q => q.Theme))]; 
    
    practice_topicSelect.innerHTML = '<option value="">-- Select Theme --</option>'; 
    
    if (themes.length === 0) {
        practice_topicSelect.innerHTML = `<option>No Themes Available</option>`;
        practice_questionSelect.innerHTML = `<option>Select a Theme first...</option>`;
        return;
    }
    themes.sort().forEach(theme => {
        if (theme) { 
            const opt = document.createElement('option');
            opt.value = theme;
            opt.textContent = theme;
            practice_topicSelect.appendChild(opt);
        }
    });

    // Automatically call the next step or reset the questions dropdown
    practice_populateQuestions();
}


function practice_populateQuestions() {
    const selectedTheme = practice_topicSelect.value;
    const selectedType = currentPracticeTypeInput.value;
    practice_questionSelect.innerHTML = '';
    
    if (!selectedTheme) {
        practice_questionSelect.innerHTML = `<option>Select a Theme first...</option>`;
        return;
    }

    // Filter questions based on both Skill (Col A) and Theme (Col B)
    const questions = practice_allQuestions.filter(q => 
        q.Skill === selectedType && q.Theme === selectedTheme
    );

    if (questions.length === 0) {
        practice_questionSelect.innerHTML = `<option>No Questions Available</option>`;
        return;
    }
    
    questions.forEach((q, index) => {
        const opt = document.createElement('option');
        // Store the full URL (Content - Col D) as the value
        opt.value = q.Content; 
        // Display the question (Col C)
        opt.textContent = q.Question; 
        practice_questionSelect.appendChild(opt);
    });
}

function practice_generateQuestion() {
    const selectedContentUrl = practice_questionSelect.value;
    
    if (!selectedContentUrl) {
        practice_questionDisplay.innerHTML = `<h2>Please select a Question.</h2><p>Please select a Theme first, then select a Question from the list.</p>`;
        return;
    }

    // Find the specific question object based on the Content URL
    const q = practice_allQuestions.find(item => item.Content === selectedContentUrl);
    
    if (!q) {
        practice_questionDisplay.innerHTML = `<p>Error: Content not found.</p>`;
        return;
    }
    
    fullscreenBtn.classList.add('hide');
    fullscreenBtn.onclick = null;

    let contentHtml = q.Content;
    const originalUrl = q.Content;

    // Slide/Embed Logic
    if (originalUrl && originalUrl.includes('google.com/presentation')) {
        const fileIdMatch = originalUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
        
        // Match either ?slide= or #slide=
        const slideIdMatch = originalUrl.match(/[?#]slide=id\.([a-zA-Z0-9_.-]+)/);

        if (fileIdMatch) {
            const fileId = fileIdMatch[1];
            let embedUrl;
            let presentUrl;

            if (slideIdMatch) {
                // Specific slide ID found
                const slideId = `id.${slideIdMatch[1]}`;
                embedUrl = `https://docs.google.com/presentation/d/${fileId}/embed?start=false&loop=false&slide=${slideId}`;
                // Presentation link format must use a hash for navigation
                presentUrl = `https://docs.google.com/presentation/d/${fileId}/present#slide=${slideId}`;
            } else {
                // No slide ID, link to the start
                embedUrl = `https://docs.google.com/presentation/d/${fileId}/embed?start=false&loop=false`;
                presentUrl = `https://docs.google.com/presentation/d/${fileId}/present`;
            }
            
            contentHtml = `<iframe src="${embedUrl}" allowfullscreen></iframe>`;
            
            fullscreenBtn.classList.remove('hide');
            fullscreenBtn.onclick = () => { window.open(presentUrl, '_blank'); };
        }
    }
    
    practice_questionDisplay.innerHTML = `<h2>${q.Question}</h2>${contentHtml}`;
}

// --- Vocabulary Section Logic ---
const vocab_themeMap = {
    '1': '1-Personal world',
    '2': '2-Lifestyle',
    '3': '3-Neighbourhood',
    '4': '4-Media & Tech',
    '5': '5-Study & future',
    '6': '6-Travel and Tourism'
};

function vocab_initializeSelectors() {
    const themes = [...new Set(Object.keys(vocab_vocabSets).map(k => k.split('.')[0]))];
    vocab_themeSelect.innerHTML = '<option value="">-- Select Theme --</option>';
    themes.sort().forEach(theme => {
        const opt = document.createElement('option');
        opt.value = theme;
        opt.textContent = vocab_themeMap[theme] || `Theme ${theme}`;
        vocab_themeSelect.appendChild(opt);
    });
    vocab_updateSetDropdown();
}

function vocab_updateSetDropdown() {
    const theme = vocab_themeSelect.value;
    vocab_setSelect.innerHTML = '';
    vocab_setSelect2.innerHTML = '';
    
    const none = document.createElement('option');
    none.value = '';
    none.textContent = '-- None --';
    vocab_setSelect2.appendChild(none);

    if (!theme) return;

    const sets = [...new Set(Object.keys(vocab_vocabSets).filter(k => k.startsWith(theme + '.')).map(k => k))];
    sets.sort().forEach(setName => {
        const opt1 = document.createElement('option');
        opt1.value = setName;
        
        const topicName = setName.substring(setName.indexOf('.') + 1);
        
        opt1.textContent = `${topicName} (${vocab_vocabSets[setName].length} words)`;
        vocab_setSelect.appendChild(opt1);
        vocab_setSelect2.appendChild(opt1.cloneNode(true));
    });
}

vocab_themeSelect.addEventListener('change', vocab_updateSetDropdown);
vocab_generateBtn.addEventListener('click', vocab_generateTest);
vocab_revealBtn.addEventListener('click', vocab_revealAnswers);
document.getElementById('vocab-print-btn').addEventListener('click', vocab_generatePrintVersion);

function vocab_generateTest() {
    const set1 = vocab_setSelect.value;
    if (!set1) return;

    let combined = [...vocab_vocabSets[set1]];
    const set2 = vocab_setSelect2.value;
    if (set2) {
        combined = combined.concat(vocab_vocabSets[set2]);
    }
    
    // De-duplicate
    let uniqueCombined = Array.from(new Map(combined.map(item => [item.target, item])).values());
    if (uniqueCombined.length === 0) return;

    // Shuffle the entire unique list once
    const shuffled = uniqueCombined.sort(() => 0.5 - Math.random());
    
    vocab_testBody.innerHTML = '';

    // Take the first 5 (or fewer) for Target -> English questions (Column 2 is question, Column 3 is answer)
    const targetFirstQuestions = shuffled.slice(0, 5);
    targetFirstQuestions.forEach((item, i) => {
        const row = vocab_testBody.insertRow();
        row.innerHTML = `<td class="num-cell">${i + 1}</td><td>${item.target}</td><td class="answer-cell"><span>${item.english}</span></td>`;
    });

    // Take the next 5 (or fewer) for English -> Target questions (Column 3 is question, Column 2 is answer)
    const englishFirstQuestions = shuffled.slice(5, 10);
    englishFirstQuestions.forEach((item, i) => {
        const row = vocab_testBody.insertRow();
        const rowNumber = targetFirstQuestions.length + i + 1; // Continue numbering
        // Swap the columns: English is displayed, Target is hidden in the answer cell
        row.innerHTML = `<td class="num-cell">${rowNumber}</td><td class="answer-cell"><span>${item.target}</span></td><td>${item.english}</td>`;
    });
    
    vocab_testContainer.classList.remove('hide');
    vocab_testControls.classList.remove('hide');
    vocab_printArea.classList.add('hide');
    // Ensure answers start hidden
    document.querySelectorAll('#vocab-test-container .answer-cell span').forEach(s => s.classList.remove('visible'));
}

function vocab_revealAnswers() {
    document.querySelectorAll('#vocab-test-container .answer-cell span').forEach(s => s.classList.toggle('visible'));
}

function vocab_generatePrintVersion() {
    // Rely entirely on the @media print CSS block to control what is visible.
    
    vocab_printArea.classList.add('hide'); 
    
    document.title = "Vocabulary Test - Print Version";

    window.print();
    
    document.title = "Language Practice Hub";
}

// --- Start the App ---
initializeApp();

</script>
</body>
</html>
