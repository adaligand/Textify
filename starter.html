<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Language dHub</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background:#f0f2f5; color:#1c1e21; margin:0; padding:20px; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; }
  .container { width:100%; max-width:1400px; background:#fff; padding:25px 30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
  h1,h2 { text-align:center; color:#333; }
  .hide { display:none !important; }

  /* menu */
  #main-menu { text-align:center; }
  .menu-buttons { display:flex; justify-content:center; gap:20px; margin-top:30px; }
  .menu-button { font-size:1.2em; padding:20px 40px; border-radius:10px; border:none; color:#fff; cursor:pointer; transition:transform .2s,box-shadow .2s; }
  .menu-button:hover { transform:translateY(-3px); box-shadow:0 6px 15px rgba(0,0,0,0.15); }
  #reading-btn { background:#2980b9; } #listening-btn { background:#27ae60; } #vocab-btn { background:#8e44ad; }

  button { border:none; border-radius:8px; font-size:1em; font-weight:600; cursor:pointer; padding:12px 20px; transition:background-color .2s ease, transform .1s ease; white-space:nowrap; }
  button:hover { transform:translateY(-2px); }
  .btn-primary { background:#2980b9; color:#fff; } .btn-primary:hover { background:#3498db; }
  .btn-secondary { background:#6c757d; color:#fff; } .btn-secondary:hover { background:#5a6268; }

  .practice-controls { display:flex; gap:15px; margin-bottom:25px; align-items:flex-end; flex-wrap:wrap; }
  .practice-control-group { flex-grow:1; min-width:200px; display:flex; flex-direction:column; }
  label { font-weight:600; margin-bottom:8px; color:#606770; }

  select { font-size:16px; padding:12px; border-radius:8px; border:1px solid #dddfe2; background:#f5f6f7; }

  #question-display { border:1px solid #e0e0e0; border-radius:12px; padding:20px; min-height:400px; background:#fafafa; }
  #question-display iframe { width:100%; height:500px; border-radius:8px; border:none; }

  .vocab-main-wrapper { display:flex; gap:30px; margin-top:20px; }
  .vocab-test-panel { flex-grow:1; }
  .vocab-controls-panel { flex:0 0 350px; display:flex; flex-direction:column; gap:15px; }

  .vocab-control-group { background:#f9f9f9; border:1px solid #ddd; border-radius:8px; padding:20px; display:flex; flex-direction:column; gap:15px; }

  #vocab-test-container table { width:100%; border-collapse:collapse; font-size:1.4em; table-layout:fixed; margin-top:20px; }
  #vocab-test-container th, #vocab-test-container td { border:1px solid #ddd; padding:12px; text-align:left; }
  #vocab-test-container th:first-child, #vocab-test-container td.num-cell { width:60px; text-align:center; }
  #vocab-test-container th:nth-child(2), #vocab-test-container td:nth-child(2), #vocab-test-container th:nth-child(3), #vocab-test-container td:nth-child(3) { width:47%; }

  .answer-cell span { visibility:hidden; color:#27ae60; font-weight:bold; }
  .answer-cell span.visible { visibility:visible; }

  /* print */
  @media print {
    @page { size:A4 landscape; margin:1cm; }
    .container, #main-menu, #practice-section, .vocab-controls-panel { display:none !important; }
    #vocab-section { display:block !important; position:absolute; top:0; left:0; width:100%; padding:0; margin:0; }
    #vocab-test-container { display:block !important; width:100%; column-count:2; column-gap:20px; }
    #vocab-test-container table { width:100%; border-collapse:collapse; font-size:11pt; page-break-inside:avoid; margin-bottom:20px; table-layout:fixed; }
    #vocab-test-container th, #vocab-test-container td { border:1px solid #000; padding:5px 8px; line-height:1.2; }
    #vocab-test-container th:first-child, #vocab-test-container td.num-cell { width:50px; }
    #vocab-test-container th:nth-child(2), #vocab-test-container td:nth-child(2), #vocab-test-container th:nth-child(3), #vocab-test-container td:nth-child(3) { width:calc(50% - 25px); }
    .answer-cell span { visibility:hidden !important; }
  }
</style>
</head>
<body>
<div class="container">

  <div id="main-menu">
    <h1>Language Practice Hub</h1>
    <p>Please choose an activity</p>
    <div class="menu-buttons">
      <button id="reading-btn" class="menu-button">Reading Practice</button>
      <button id="listening-btn" class="menu-button">Listening Practice</button>
      <button id="vocab-btn" class="menu-button">Vocabulary Test</button>
    </div>
  </div>

  <div id="practice-section" class="hide">
    <h1 id="practice-title">Practice Section</h1>
    <input type="hidden" id="current-practice-type" value="">
    <div class="practice-controls">
      <div class="practice-control-group">
        <label for="topic-select">Choose a Theme:</label>
        <select id="topic-select"><option>Loading Themes...</option></select>
      </div>
      <div class="practice-control-group">
        <label for="question-select">Choose a Question:</label>
        <select id="question-select"><option>Select a Theme first...</option></select>
      </div>
      <button id="generate-practice-btn" class="btn-primary">Load Question</button>
      <button id="fullscreen-btn" class="btn-primary hide">üîà Open Full Screen</button>
      <button class="btn-primary back-btn">Back to Main Menu</button>
    </div>
    <div id="question-display">
      <h2>Your question will appear here</h2>
      <p>Select a theme and question, then click "Load Question".</p>
    </div>
  </div>

  <div id="vocab-section" class="hide">
    <div class="vocab-main-wrapper">
      <div class="vocab-test-panel">
        <div id="vocab-test-container" class="hide">
          <table>
            <thead><tr><th>No.</th><th>Target Language</th><th>English</th></tr></thead>
            <tbody id="vocab-test-body"></tbody>
          </table>
        </div>
      </div>

      <div class="vocab-controls-panel" id="vocab-controls-panel">
        <h1>Vocabulary Test</h1>
        <div id="vocab-setup-controls" class="vocab-control-group">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <label for="vocab-theme-select">Theme:</label>
            <select id="vocab-theme-select" style="width:60%;"></select>
          </div>
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <label for="vocab-set-select">Set:</label>
            <select id="vocab-set-select" style="width:60%;"></select>
          </div>
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <label for="vocab-set-select-2">2nd set (Optional):</label>
            <select id="vocab-set-select-2" style="width:60%;"></select>
          </div>
          <button id="vocab-generate-btn" class="btn-primary">Generate List</button>
        </div>

        <div id="vocab-action-buttons" style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
          <button id="vocab-reveal-btn" class="btn-primary">Reveal Answers</button>
          <button id="vocab-print-btn" class="btn-primary">üñ®Ô∏è Print Test</button>
          <button class="btn-primary back-btn">Back to Main Menu</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* URLs */
const practiceSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRvNFlHDx-4cZbDzwKy5Yb_DKeSxS2wSXxyX1Ua6pGcf27yFjmqOPz9jQ_rzoV3-zoZI9lw4EIfmdXH/pub?output=csv";
const vocabSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCNeq329ih6SxLZ2TowPzpk61gJLFy-UAVAb8ivBs9DNEOdmtRQ29bWh__n53MdE-C8hs_XOV3iIkT/pub?output=csv";

/* state */
let practice_allQuestions = [];
let vocab_vocabSets = {};

/* DOM refs */
const mainMenu = document.getElementById('main-menu');
const practiceSection = document.getElementById('practice-section');
const vocabSection = document.getElementById('vocab-section');
const readingBtn = document.getElementById('reading-btn');
const listeningBtn = document.getElementById('listening-btn');
const vocabBtn = document.getElementById('vocab-btn');
const currentPracticeTypeInput = document.getElementById('current-practice-type');

const practice_topicSelect = document.getElementById('topic-select');
const practice_questionSelect = document.getElementById('question-select');
const practice_generateBtn = document.getElementById('generate-practice-btn');
const practice_questionDisplay = document.getElementById('question-display');
const fullscreenBtn = document.getElementById('fullscreen-btn');

const vocab_themeSelect = document.getElementById('vocab-theme-select');
const vocab_setSelect = document.getElementById('vocab-set-select');
const vocab_setSelect2 = document.getElementById('vocab-set-select-2');
const vocab_generateBtn = document.getElementById('vocab-generate-btn');
const vocab_testContainer = document.getElementById('vocab-test-container');
const vocab_testBody = document.getElementById('vocab-test-body');
const vocab_revealBtn = document.getElementById('vocab-reveal-btn');

/* navigation */
readingBtn.addEventListener('click', () => showPractice('Reading'));
listeningBtn.addEventListener('click', () => showPractice('Listening'));
vocabBtn.addEventListener('click', showVocabTest);
document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', showMainMenu));

function showMainMenu() {
  mainMenu.classList.remove('hide');
  practiceSection.classList.add('hide');
  vocabSection.classList.add('hide');
}

function showPractice(type) {
  mainMenu.classList.add('hide');
  practiceSection.classList.remove('hide');
  vocabSection.classList.add('hide');
  document.getElementById('practice-title').textContent = `${type} Practice`;
  currentPracticeTypeInput.value = type;
  practice_populateTopics();
}

function showVocabTest() {
  mainMenu.classList.add('hide');
  practiceSection.classList.add('hide');
  vocabSection.classList.remove('hide');

  // RESET THE TEST
  vocab_testBody.innerHTML = '';
  vocab_testContainer.classList.add('hide');
  vocab_themeSelect.value = '';
  vocab_setSelect.innerHTML = '';
  vocab_setSelect2.innerHTML = '';
  vocab_revealBtn.textContent = 'Reveal Answers';
}

/* CSV loader */
function loadData(url, options) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      ...options,
      download: true,
      skipEmptyLines: true,
      complete: results => resolve(results.data),
      error: err => reject(err)
    });
  });
}

/* initialize app */
async function initializeApp() {
  readingBtn.disabled = true; listeningBtn.disabled = true; vocabBtn.disabled = true;
  try {
    const [practiceData, vocabData] = await Promise.all([
      loadData(practiceSheetUrl, { header: true }),
      loadData(vocabSheetUrl, { header: false })
    ]);

    practice_allQuestions = practiceData.map(row => ({
      Skill: (row.Skill || "").trim(),
      Theme: (row.Theme || "").trim(),
      Question: (row.Question || "").trim(),
      Content: (row.Content || "").trim()
    })).filter(q => q.Skill && q.Theme && q.Content);

    // vocab parsing
    vocab_vocabSets = {};
    let currentTheme = null, currentKey = null;
    vocabData.forEach(row => {
      if (!row) return;
      const rawTheme = (row[0] || "").trim();
      const setId = (row[1] || "").trim();
      const target = (row[3] || "").trim();
      const english = (row[4] || "").trim();

      if (rawTheme) currentTheme = rawTheme;
      if (setId) currentKey = `${currentTheme}.${setId}`;
      if (!currentTheme || !currentKey) return;

      if (target && english) {
        if (!vocab_vocabSets[currentKey]) vocab_vocabSets[currentKey] = [];
        vocab_vocabSets[currentKey].push({ target, english });
      }
    });

    vocab_initializeSelectors();
    readingBtn.disabled = false; listeningBtn.disabled = false; vocabBtn.disabled = false;
  } catch (err) {
    console.error("Load error:", err);
    document.querySelector('.container').innerHTML = '<h1>Error</h1><p>Could not load spreadsheet data. Check URLs & publishing.</p>';
  }
}

/* practice logic */
function practice_populateTopics() {
  const skill = currentPracticeTypeInput.value; // Reading or Listening
  const themes = [...new Set(practice_allQuestions
                     .filter(q => q.Skill.toLowerCase() === skill.toLowerCase())
                     .map(q => q.Theme))].sort();

  practice_topicSelect.innerHTML = '';
  themes.forEach(theme => {
    const opt = document.createElement('option');
    opt.value = theme;
    opt.textContent = theme;
    practice_topicSelect.appendChild(opt);
  });

  practice_questionSelect.innerHTML = '<option>Select a Theme first...</option>';
}

/* vocab logic */
function vocab_initializeSelectors() {
  const themes = [...new Set(Object.keys(vocab_vocabSets).map(k => k.split('.')[0]))].filter(Boolean).sort();
  vocab_themeSelect.innerHTML = '<option value="">-- Select Theme --</option>';
  themes.forEach(theme => {
    const opt = document.createElement('option');
    opt.value = theme;
    opt.textContent = theme;
    vocab_themeSelect.appendChild(opt);
  });

  vocab_themeSelect.addEventListener('change', vocab_updateSetDropdown);
  vocab_generateBtn.addEventListener('click', vocab_generateTest);
  vocab_revealBtn.addEventListener('click', () => {
    const allSpans = document.querySelectorAll('#vocab-test-container .answer-cell span');
    const anyHidden = Array.from(allSpans).some(s => !s.classList.contains('visible'));
    allSpans.forEach(s => s.classList.toggle('visible', anyHidden));
    vocab_revealBtn.textContent = anyHidden ? 'Hide Answers' : 'Reveal Answers';
  });
  document.getElementById('vocab-print-btn').addEventListener('click', () => window.print());
}

function vocab_updateSetDropdown() {
  const theme = vocab_themeSelect.value;
  vocab_setSelect.innerHTML = '';
  vocab_setSelect2.innerHTML = '';
  const noneOpt = document.createElement('option');
  noneOpt.value = '';
  noneOpt.textContent = '-- None --';
  vocab_setSelect2.appendChild(noneOpt);

  if (!theme) {
    vocab_setSelect.innerHTML = '<option value="">Select Theme First</option>';
    return;
  }

  const setKeys = Object.keys(vocab_vocabSets).filter(k => k.startsWith(theme + '.')).sort();
  if (setKeys.length === 0) {
    vocab_setSelect.innerHTML = '<option value="">No Sets Available</option>';
    return;
  }

  setKeys.forEach(key => {
    const topicName = key.substring(key.indexOf('.') + 1);
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = `${topicName} (${vocab_vocabSets[key].length} words)`;
    vocab_setSelect.appendChild(opt);
    vocab_setSelect2.appendChild(opt.cloneNode(true));
  });
}

function vocab_generateTest() {
  const setKey1 = vocab_setSelect.value;
  if (!setKey1) return;
  let combined = Array.isArray(vocab_vocabSets[setKey1]) ? [...vocab_vocabSets[setKey1]] : [];
  const setKey2 = vocab_setSelect2.value;
  if (setKey2) combined = combined.concat(vocab_vocabSets[setKey2] || []);

  const unique = Array.from(new Map(combined.map(item => [item.target, item])).values());
  if (unique.length === 0) {
    vocab_testBody.innerHTML = '';
    vocab_testContainer.classList.add('hide');
    return;
  }

  const shuffled = unique.sort(() => 0.5 - Math.random());
  vocab_testBody.innerHTML = '';

  const targetFirst = shuffled.slice(0, 5);
  targetFirst.forEach((item, i) => {
    const row = vocab_testBody.insertRow();
    row.innerHTML = `<td class="num-cell">${i + 1}</td><td>${item.target}</td><td class="answer-cell"><span>${item.english}</span></td>`;
  });

  const englishFirst = shuffled.slice(5, 10);
  englishFirst.forEach((item, i) => {
    const rowNumber = targetFirst.length + i + 1;
    const row = vocab_testBody.insertRow();
    row.innerHTML = `<td class="num-cell">${rowNumber}</td><td class="answer-cell"><span>${item.target}</span></td><td>${item.english}</td>`;
  });

  vocab_testContainer.classList.remove('hide');
  document.querySelectorAll('#vocab-test-container .answer-cell span').forEach(s => s.classList.remove('visible'));
}

/* Initialize app */
initializeApp();
</script>
</body>
</html>

